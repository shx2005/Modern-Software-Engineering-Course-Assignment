<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>空域红包战线</title>
    <style>
      :root {
        color-scheme: dark;
        font-family: "Montserrat", "Segoe UI", -apple-system, BlinkMacSystemFont, sans-serif;
        --bg-gradient: radial-gradient(circle at top, #1e3a8a 0%, #0f172a 45%, #020617 100%);
        --panel-bg: rgba(14, 23, 42, 0.75);
        --panel-border: rgba(148, 163, 184, 0.28);
        --text-primary: #f8fafc;
        --text-secondary: rgba(226, 232, 240, 0.7);
        --accent-blue: #38bdf8;
        --accent-green: #4ade80;
        --accent-orange: #fb923c;
        --accent-pink: #f472b6;
        --cell-size: 30px;
        --glow-shadow: 0 18px 45px rgba(15, 118, 110, 0.45);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        color: var(--text-primary);
        background: var(--bg-gradient);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow-x: hidden;
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        background:
          radial-gradient(circle at 15% 20%, rgba(59, 130, 246, 0.3) 0, rgba(59, 130, 246, 0) 45%),
          radial-gradient(circle at 85% 25%, rgba(16, 185, 129, 0.28) 0, rgba(16, 185, 129, 0) 50%),
          radial-gradient(circle at 50% 80%, rgba(236, 72, 153, 0.22) 0, rgba(236, 72, 153, 0) 55%);
        mix-blend-mode: screen;
        z-index: -2;
        animation: nebulaDrift 18s ease-in-out infinite alternate;
      }

      body::after {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        background-image: url("data:image/svg+xml,%3Csvg width='1440' height='900' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.08'%3E%3Ccircle cx='120' cy='180' r='1.5'/%3E%3Ccircle cx='480' cy='220' r='1'/%3E%3Ccircle cx='860' cy='160' r='1.3'/%3E%3Ccircle cx='1260' cy='140' r='1.6'/%3E%3Ccircle cx='280' cy='560' r='1.2'/%3E%3Ccircle cx='940' cy='640' r='1.4'/%3E%3Ccircle cx='660' cy='420' r='1.1'/%3E%3Ccircle cx='1110' cy='780' r='1.5'/%3E%3Ccircle cx='180' cy='820' r='1.4'/%3E%3Ccircle cx='1320' cy='540' r='1.2'/%3E%3C/g%3E%3C/svg%3E");
        background-size: 1200px 900px;
        opacity: 0.55;
        mix-blend-mode: screen;
        animation: starParallax 28s linear infinite;
        z-index: -3;
      }

      @keyframes nebulaDrift {
        0% {
          transform: translate3d(-2%, -1%, 0) scale(1);
        }
        100% {
          transform: translate3d(2%, 1%, 0) scale(1.05);
        }
      }

      @keyframes starParallax {
        0% {
          transform: translateY(0);
        }
        100% {
          transform: translateY(80px);
        }
      }

      header {
        width: 100%;
        padding: 2.5rem 1.5rem 1.5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
        position: relative;
      }

      header h1 {
        margin: 0;
        font-size: clamp(2rem, 5vw, 3rem);
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        background: linear-gradient(90deg, #38bdf8, #f472b6, #fb923c, #38bdf8);
        background-size: 220% auto;
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: headingPulse 6s linear infinite;
      }

      header p {
        margin: 0;
        font-size: 1rem;
        color: var(--text-secondary);
        letter-spacing: 0.05em;
        text-align: center;
      }

      @keyframes headingPulse {
        0% {
          background-position: 0%;
        }
        100% {
          background-position: 200%;
        }
      }

      main {
        width: min(1100px, 100%);
        margin: 0 auto;
        padding: 0 1.5rem 2.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.75rem;
      }

      .hud {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1.25rem;
      }

      .hud-card {
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        border-radius: 1.1rem;
        padding: 1rem 1.4rem;
        box-shadow: 0 16px 40px rgba(8, 47, 73, 0.45);
        position: relative;
        overflow: hidden;
      }

      .hud-card::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at top, rgba(56, 189, 248, 0.2), transparent 60%);
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .hud-card:hover::after {
        opacity: 1;
      }

      .hud-card > div:first-child {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.15em;
        color: var(--text-secondary);
      }

      .hud-card .status {
        font-size: 1.8rem;
        font-weight: 700;
        margin-top: 0.4rem;
      }

      .battlefield-shell {
        background: var(--panel-bg);
        border-radius: 1.3rem;
        border: 1px solid var(--panel-border);
        padding: 1.5rem;
        box-shadow: 0 25px 55px rgba(7, 89, 133, 0.35);
        position: relative;
        overflow: hidden;
      }

      .battlefield-shell::before {
        content: "";
        position: absolute;
        inset: -20%;
        background: conic-gradient(from 90deg, rgba(59, 130, 246, 0.25), rgba(236, 72, 153, 0.2), rgba(129, 140, 248, 0.3), rgba(59, 130, 246, 0.25));
        filter: blur(40px);
        opacity: 0.35;
        animation: aurora 12s ease-in-out infinite;
        z-index: 0;
      }

      @keyframes aurora {
        0%,
        100% {
          transform: translate(-10%, -10%) rotate(0deg);
        }
        50% {
          transform: translate(10%, 10%) rotate(20deg);
        }
      }

      .battlefield {
        position: relative;
        margin: 0 auto;
        border-radius: 1rem;
        overflow: hidden;
        border: 1px solid rgba(148, 163, 184, 0.35);
        box-shadow: inset 0 0 25px rgba(15, 23, 42, 0.65);
        background-color: rgba(15, 23, 42, 0.88);
      }

      .battlefield::before {
        content: "";
        position: absolute;
        inset: 0;
        background-image: linear-gradient(
            rgba(94, 234, 212, 0.12) 1px,
            transparent 1px
          ),
          linear-gradient(90deg, rgba(59, 130, 246, 0.12) 1px, transparent 1px);
        background-size: var(--cell-size) var(--cell-size);
        animation: runwayScroll 12s linear infinite;
        opacity: 0.85;
        z-index: 0;
      }

      @keyframes runwayScroll {
        from {
          transform: translateY(0);
        }
        to {
          transform: translateY(var(--cell-size));
        }
      }

      #grid {
        position: relative;
        width: 100%;
        height: 100%;
        z-index: 1;
      }

      .envelope-layer,
      .effect-layer {
        position: absolute;
        inset: 0;
        pointer-events: none;
      }

      .envelope {
        position: absolute;
        left: 0;
        top: 0;
        width: var(--cell-size);
        height: var(--cell-size);
        border-radius: 0.85rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #0f172a;
        font-weight: 700;
        font-size: 0.9rem;
        transform-origin: center;
        transition: transform 0.2s ease-out;
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.45);
        will-change: transform;
      }

      .envelope[data-size="Small"] {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
      }

      .envelope[data-size="Medium"] {
        background: linear-gradient(135deg, #f97316, #fb923c);
      }

      .envelope[data-size="Large"] {
        background: linear-gradient(135deg, #f43f5e, #fb7185);
        color: #fff;
      }

      @keyframes envelopeFloat {
        0%,
        100% {
          transform: translateY(0) scale(1);
        }
        50% {
          transform: translateY(-6px) scale(1.04);
        }
      }

      .envelope-value {
        text-shadow: 0 1px 4px rgba(15, 23, 42, 0.45);
      }

      .tank-overlay {
        position: absolute;
        width: var(--cell-size);
        height: var(--cell-size);
        border-radius: 40%;
        display: flex;
        align-items: center;
        justify-content: center;
        transform-origin: center;
        transform: translate3d(0, 0, 0);
        transition: transform 0.18s ease-out;
        pointer-events: none;
        z-index: 3;
      }

      .tank-overlay::before {
        content: "";
        position: absolute;
        width: 70px;
        height: 70px;
        border-radius: 50%;
        border: 2px dashed rgba(56, 189, 248, 0.55);
        animation: radar 2s linear infinite;
      }

      .tank-overlay::after {
        content: "";
        position: absolute;
        inset: -12px;
        border-radius: 50%;
        background: radial-gradient(circle, rgba(56, 189, 248, 0.45), rgba(14, 165, 233, 0));
        filter: blur(2px);
        opacity: 0.8;
      }

      @keyframes radar {
        0% {
          transform: scale(0.95) rotate(0deg);
        }
        100% {
          transform: scale(1.05) rotate(360deg);
        }
      }

      .tank-body {
        position: relative;
        width: 100%;
        height: 100%;
        border-radius: 20%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        background: rgba(15, 23, 42, 0.6);
        box-shadow: 0 10px 20px rgba(15, 23, 42, 0.45), inset 0 0 12px rgba(59, 130, 246, 0.6);
      }

      .tank-body img {
        width: 115%;
        height: 115%;
        object-fit: cover;
        border-radius: 20%;
        filter: drop-shadow(0 6px 14px rgba(59, 130, 246, 0.45));
        mix-blend-mode: normal;
      }

      .controls {
        display: none;
      }

      .control-helpers {
        display: none;
      }

      .controls-hint {
        color: var(--text-secondary);
        font-size: 0.95rem;
        text-align: center;
      }

      .action-button {
        --hover-scale: 1;
        --hover-glow: 0;
        background: linear-gradient(160deg, rgba(56, 189, 248, 0.85), rgba(59, 130, 246, 1));
        color: var(--text-primary);
        border: none;
        border-radius: 0.95rem;
        font-size: 1rem;
        font-weight: 600;
        letter-spacing: 0.05em;
        cursor: pointer;
        padding: 0.85rem 1.4rem;
        transition: transform 0.18s ease, box-shadow 0.25s ease, background 0.3s ease;
        transform: perspective(400px) scale(var(--hover-scale));
        box-shadow: 0 15px 35px rgba(15, 23, 42, 0.4);
        position: relative;
        overflow: hidden;
      }

      .action-button::before {
        content: "";
        position: absolute;
        inset: -120%;
        background: radial-gradient(circle at center, rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0));
        opacity: calc(var(--hover-glow) * 0.75);
        transform: translate(calc(50% - 50%), calc(50% - 50%));
        transition: opacity 0.25s ease;
      }

      .action-button:active {
        transform: scale(0.94);
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.55);
      }

      .action-button.secondary {
        background: linear-gradient(160deg, rgba(110, 231, 183, 0.9), rgba(34, 197, 94, 1));
      }

      .action-button.alt {
        background: linear-gradient(160deg, rgba(250, 204, 21, 0.92), rgba(249, 115, 22, 1));
      }

      .action-button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        box-shadow: none;
        transform: scale(1);
      }

      .wide-button {
        min-width: 220px;
      }

      .summary {
        background: var(--panel-bg);
        border-radius: 1.2rem;
        border: 1px solid var(--panel-border);
        padding: 1.75rem 2rem;
        box-shadow: 0 20px 50px rgba(12, 74, 110, 0.45);
      }

      .summary h2 {
        margin: 0 0 0.75rem;
        font-size: 1.45rem;
        letter-spacing: 0.08em;
      }

      .summary p {
        margin: 0.3rem 0;
        color: var(--text-secondary);
        line-height: 1.7;
      }

      .attendance-section {
        background: var(--panel-bg);
        border-radius: 1.2rem;
        border: 1px solid var(--panel-border);
        padding: 1.75rem 2rem;
        box-shadow: 0 20px 45px rgba(8, 47, 73, 0.35);
        margin-top: 1rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .attendance-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .attendance-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      .attendance-primary,
      .attendance-secondary {
        --hover-scale: 1;
        border: none;
        border-radius: 0.85rem;
        padding: 0.6rem 1.4rem;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        color: var(--text-primary);
        transition: transform 0.18s ease, box-shadow 0.25s ease;
        transform: perspective(400px) scale(var(--hover-scale));
      }

      .attendance-primary {
        background: linear-gradient(135deg, #34d399, #10b981);
        box-shadow: 0 15px 35px rgba(16, 185, 129, 0.35);
      }

      .attendance-secondary {
        background: linear-gradient(135deg, #818cf8, #6366f1);
        box-shadow: 0 12px 28px rgba(99, 102, 241, 0.3);
      }

      .attendance-primary:disabled,
      .attendance-secondary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        box-shadow: none;
        transform: scale(1);
      }

      .attendance-meta {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }

      .attendance-label {
        font-size: 0.85rem;
        letter-spacing: 0.15em;
        text-transform: uppercase;
        color: var(--text-secondary);
        margin: 0;
      }

      .attendance-name {
        margin: 0;
        font-size: 1.6rem;
        font-weight: 600;
      }

      .attendance-id {
        margin: 0;
        font-size: 0.95rem;
        color: var(--text-secondary);
      }

      .attendance-nav {
        display: flex;
        gap: 0.75rem;
        align-items: center;
      }

      .attendance-nav button {
        --hover-scale: 1;
        --hover-glow: 0;
        border: none;
        border-radius: 0.95rem;
        padding: 0.65rem 1.4rem;
        font-size: 0.95rem;
        font-weight: 600;
        color: #0f172a;
        box-shadow: 0 12px 30px rgba(249, 115, 22, 0.35);
        cursor: pointer;
        transition: transform 0.18s ease, box-shadow 0.25s ease;
        transform: perspective(400px) scale(var(--hover-scale));
      }

      .attendance-nav .attendance-prev {
        background: linear-gradient(135deg, #c084fc, #a855f7);
        color: var(--text-primary);
        box-shadow: 0 12px 30px rgba(168, 85, 247, 0.35);
      }

      .attendance-nav .attendance-next {
        background: linear-gradient(135deg, #fde047, #fb923c);
      }

      .attendance-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.85rem;
      }

      .attendance-action {
        --hover-scale: 1;
        --hover-glow: 0;
        flex: 1;
        min-width: 140px;
        border: none;
        border-radius: 0.9rem;
        padding: 0.85rem 1rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        color: var(--text-primary);
        transition: transform 0.18s ease, box-shadow 0.25s ease;
        transform: perspective(400px) scale(var(--hover-scale));
        box-shadow: 0 15px 35px rgba(15, 23, 42, 0.4);
        background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      }

      .attendance-action.present {
        background: linear-gradient(135deg, #34d399, #10b981);
      }

      .attendance-action.leave {
        background: linear-gradient(135deg, #fbbf24, #f97316);
      }

      .attendance-action.absent {
        background: linear-gradient(135deg, #f87171, #ef4444);
      }

      .attendance-action:disabled,
      .attendance-nav button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        box-shadow: none;
        transform: scale(1);
      }

      .attendance-message {
        min-height: 1.2rem;
        color: var(--text-secondary);
      }

      .attendance-message.success {
        color: #4ade80;
      }

      .attendance-message.error {
        color: #f87171;
      }

      .attendance-summary {
        background: rgba(15, 23, 42, 0.45);
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: 1rem;
        padding: 1rem 1.25rem;
      }

      .attendance-summary[hidden] {
        display: none;
      }

      .attendance-chart {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
        margin-top: 0.75rem;
      }

      .attendance-bar-row {
        display: flex;
        align-items: center;
        gap: 0.65rem;
      }

      .attendance-bar-label {
        width: 52px;
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      .attendance-bar-track {
        flex: 1;
        height: 14px;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.15);
        overflow: hidden;
      }

      .attendance-bar-fill {
        height: 100%;
        border-radius: 999px;
        background: linear-gradient(90deg, #4ade80, #22c55e);
        width: 0%;
      }

      .attendance-bar-fill.leave {
        background: linear-gradient(90deg, #facc15, #f97316);
      }

      .attendance-bar-fill.absent {
        background: linear-gradient(90deg, #fb7185, #ef4444);
      }

      .attendance-bar-value {
        width: 60px;
        text-align: right;
        color: var(--text-secondary);
        font-size: 0.9rem;
      }

      .attendance-empty {
        margin: 0;
        color: var(--text-secondary);
      }

      footer {
        margin-top: auto;
        padding: 1.75rem 1.5rem;
        text-align: center;
        color: var(--text-secondary);
        font-size: 0.9rem;
      }

      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(2, 6, 23, 0.78);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        backdrop-filter: blur(10px);
      }

      .overlay[hidden] {
        display: none;
      }

      .overlay-card {
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.35);
        padding: 2.4rem 3rem;
        border-radius: 1.4rem;
        text-align: center;
        box-shadow: 0 18px 45px rgba(15, 23, 42, 0.65);
        max-width: 400px;
      }

      .overlay-card h2 {
        margin: 0 0 1rem;
        font-size: 1.8rem;
      }

      .overlay-card p {
        margin: 0 0 1.5rem;
        color: var(--text-secondary);
        line-height: 1.6;
      }

      #rain-overlay {
        position: fixed;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
        display: none;
        z-index: 90;
      }

      #rain-overlay.active {
        display: block;
      }

      .rain-drop {
        position: absolute;
        top: -15%;
        width: 34px;
        height: 34px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        animation-name: rain-fall;
        animation-timing-function: linear;
        animation-fill-mode: forwards;
      }

      .rain-drop span {
        pointer-events: none;
        font-weight: 700;
        color: #0f172a;
      }

      .shape-size {
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 0.05em;
      }

      .shape-small {
        background: linear-gradient(135deg, #fef08a, #fde047);
        border-radius: 50%;
        box-shadow: 0 0 18px rgba(250, 204, 21, 0.55);
      }

      .shape-medium {
        background: linear-gradient(135deg, #fb7185, #f97316);
        box-shadow: 0 0 18px rgba(249, 115, 22, 0.55);
      }

      .shape-large {
        background: linear-gradient(135deg, #f43f5e, #c026d3);
        box-shadow: 0 0 20px rgba(236, 72, 153, 0.65);
      }

      .rain-drop.shape-medium {
        transform: rotate(45deg);
      }

      .rain-drop.shape-medium span {
        transform: rotate(-45deg);
      }

      .rain-drop.shape-large {
        clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
      }

      @keyframes rain-fall {
        0% {
          transform: translateY(-120%) scale(0.85);
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        100% {
          transform: translateY(140vh) scale(1.1);
          opacity: 0;
        }
      }

      .duck-panel {
        position: fixed;
        left: 24px;
        bottom: 24px;
        width: 120px;
        height: 120px;
        border-radius: 20px;
        background: rgba(15, 23, 42, 0.78);
        border: 1px solid rgba(148, 163, 184, 0.35);
        box-shadow: 0 15px 35px rgba(15, 23, 42, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.25s ease, box-shadow 0.25s ease;
        z-index: 120;
      }

      .duck-panel:hover {
        transform: translateY(-6px) scale(1.05);
        box-shadow: 0 20px 45px rgba(59, 130, 246, 0.4);
      }

      #duck-helper {
        max-width: 100px;
        max-height: 100px;
        filter: drop-shadow(0 6px 12px rgba(59, 130, 246, 0.45));
      }

      .duck-avatar {
        position: relative;
        width: 110px;
        height: 110px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .duck-layer {
        position: absolute;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.25s ease;
      }

      .duck-layer.active {
        opacity: 1;
      }

      .duck-layer.hat {
        width: 122px;
        top: -22px;
        left: -10px;
      }

      .duck-layer.cloth {
        width: 110px;
        top: 30px;
        left: -5px;
      }

      .duck-settings-button {
        position: fixed;
        left: 24px;
        bottom: 160px;
        padding: 0.55rem 1.4rem;
        border-radius: 999px;
        border: none;
        background: linear-gradient(135deg, #facc15, #fb923c);
        color: #0f172a;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 12px 30px rgba(250, 204, 21, 0.45);
        transition: transform 0.25s ease, box-shadow 0.25s ease;
        z-index: 121;
      }

      .duck-settings-button:hover {
        transform: translateY(-4px);
        box-shadow: 0 18px 38px rgba(250, 204, 21, 0.6);
      }

      .duck-settings-panel {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        width: min(360px, 90vw);
        padding: 1.5rem;
        background: rgba(15, 23, 42, 0.95);
        border-right: 1px solid rgba(148, 163, 184, 0.3);
        box-shadow: 12px 0 40px rgba(2, 6, 23, 0.6);
        transform: translateX(-110%);
        transition: transform 0.3s ease;
        z-index: 170;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .duck-settings-panel.open {
        transform: translateX(0);
      }

      .duck-settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .duck-settings-header h3 {
        margin: 0;
        font-size: 1.1rem;
        letter-spacing: 0.05em;
      }

      .duck-settings-close {
        border: none;
        background: transparent;
        color: rgba(226, 232, 240, 0.7);
        font-size: 1.4rem;
        cursor: pointer;
      }

      .duck-settings-close:hover {
        color: #fff;
      }

      .duck-settings-section h4 {
        margin: 0.4rem 0;
        font-size: 0.95rem;
        letter-spacing: 0.05em;
        color: var(--text-secondary);
      }

      .duck-settings-track {
        display: flex;
        gap: 0.75rem;
        overflow-x: auto;
        padding-bottom: 0.5rem;
        scroll-snap-type: x mandatory;
      }

      .duck-settings-option {
        min-width: 110px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        border-radius: 1rem;
        padding: 0.5rem;
        background: rgba(15, 23, 42, 0.65);
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        scroll-snap-align: start;
        transition: border-color 0.2s ease, transform 0.2s ease;
      }

      .duck-settings-option span {
        font-size: 0.8rem;
        color: var(--text-secondary);
        text-align: center;
      }

      .duck-settings-option img {
        width: 92px;
        height: 92px;
        object-fit: contain;
      }

      .duck-settings-option.active {
        border-color: #38bdf8;
        transform: translateY(-3px);
      }

      .duck-settings-overlay {
        position: fixed;
        inset: 0;
        background: rgba(2, 6, 23, 0.45);
        backdrop-filter: blur(2px);
        z-index: 165;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }

      .duck-settings-overlay.visible {
        opacity: 1;
        pointer-events: auto;
      }

      .duck-dialog {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(2, 6, 23, 0.68);
        backdrop-filter: blur(8px);
        z-index: 140;
      }

      .duck-dialog[hidden] {
        display: none;
      }

      .duck-dialog-card {
        width: min(360px, 92vw);
        padding: 1.75rem;
        border-radius: 1.2rem;
        background: rgba(15, 23, 42, 0.92);
        border: 1px solid rgba(148, 163, 184, 0.35);
        box-shadow: 0 18px 40px rgba(8, 47, 73, 0.55);
        color: var(--text-primary);
        display: flex;
        flex-direction: column;
        gap: 1rem;
        position: relative;
      }

      .duck-dialog-body {
        display: flex;
        gap: 0.75rem;
      }

      #duck-input {
        flex: 1;
        padding: 0.75rem 0.9rem;
        border-radius: 1rem;
        border: 1px solid rgba(56, 189, 248, 0.35);
        background: rgba(15, 23, 42, 0.65);
        color: var(--text-primary);
      }

      #duck-send {
        padding: 0.75rem 1.1rem;
        border-radius: 1rem;
        border: none;
        background: linear-gradient(135deg, #22d3ee, #3b82f6);
        color: #0f172a;
        cursor: pointer;
        font-weight: 600;
        transition: transform 0.2s ease, box-shadow 0.25s ease;
      }

      #duck-send:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 25px rgba(56, 189, 248, 0.35);
      }

      .duck-close {
        position: absolute;
        top: 0.65rem;
        right: 0.75rem;
        border: none;
        background: transparent;
        color: rgba(226, 232, 240, 0.6);
        font-size: 1.5rem;
        cursor: pointer;
        transition: color 0.2s ease;
      }

      .duck-close:hover {
        color: #fff;
      }

      .duck-response {
        min-height: 1.1rem;
        color: var(--text-secondary);
        text-align: center;
      }

      .stats-modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(2, 6, 23, 0.75);
        backdrop-filter: blur(8px);
        z-index: 165;
      }

      .stats-modal.active {
        display: flex;
      }

      .stats-modal-card {
        width: min(480px, 90vw);
        padding: 1.6rem 1.8rem;
        border-radius: 1.2rem;
        background: rgba(15, 23, 42, 0.92);
        color: var(--text-primary);
        box-shadow: 0 20px 55px rgba(8, 47, 73, 0.55);
        border: 1px solid rgba(148, 163, 184, 0.35);
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .stats-modal-card h4 {
        margin: 0;
        font-size: 1.25rem;
        letter-spacing: 0.05em;
      }

      .stats-modal-close {
        position: absolute;
        top: 0.6rem;
        right: 0.8rem;
        border: none;
        background: transparent;
        color: rgba(226, 232, 240, 0.7);
        font-size: 1.4rem;
        cursor: pointer;
      }

      .stats-modal-close:hover {
        color: #fff;
      }

      .stats-panel {
        position: fixed;
        right: 24px;
        bottom: 24px;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.85rem;
        z-index: 115;
      }

      .stats-button {
        border: none;
        background: transparent;
        padding: 0;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        transition: transform 0.25s ease;
      }

      .stats-button:hover {
        transform: translateY(-6px) scale(1.05);
      }

      .stats-icon {
        width: 96px;
        height: 96px;
        object-fit: cover;
        border-radius: 22px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        box-shadow: 0 18px 40px rgba(59, 130, 246, 0.35);
        transition: box-shadow 0.25s ease, transform 0.25s ease;
      }

      .stats-button:hover .stats-icon,
      .stats-button:focus .stats-icon {
        transform: translateY(-4px);
        box-shadow: 0 24px 60px rgba(56, 189, 248, 0.4);
        outline: none;
      }

      .pause-floating {
        position: fixed;
        right: 24px;
        bottom: 160px;
        z-index: 120;
      }

      #btn-pause-floating {
        padding: 0.55rem 1.4rem;
        border-radius: 999px;
        border: none;
        background: linear-gradient(135deg, #facc15, #fb923c);
        color: #0f172a;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 12px 30px rgba(250, 204, 21, 0.45);
        transition: transform 0.25s ease, box-shadow 0.25s ease;
      }

      #btn-pause-floating:hover {
        transform: translateY(-4px);
        box-shadow: 0 18px 38px rgba(250, 204, 21, 0.6);
      }

      .stats-function-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }

      .stats-function-table th,
      .stats-function-table td {
        padding: 0.35rem 0.5rem;
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        text-align: left;
      }

      .stats-function-table th {
        color: var(--text-secondary);
        font-weight: 600;
      }

      .stats-function-table td:last-child {
        text-align: right;
      }

      .stats-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
        letter-spacing: 0.08em;
      }

      .stats-dialog {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(2, 6, 23, 0.78);
        backdrop-filter: blur(10px);
        z-index: 160;
      }

      .stats-dialog[hidden] {
        display: none;
      }

      .stats-dialog-card {
        width: min(780px, 92vw);
        max-height: 90vh;
        padding: 2rem;
        border-radius: 1.5rem;
        background: rgba(15, 23, 42, 0.88);
        border: 1px solid rgba(148, 163, 184, 0.35);
        box-shadow: 0 25px 65px rgba(8, 47, 73, 0.6);
        color: var(--text-primary);
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
        overflow-y: auto;
      }

      .stats-dialog-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
      }

      .stats-dialog-header h3 {
        margin: 0;
        font-size: 1.4rem;
        letter-spacing: 0.08em;
      }

      .stats-close {
        border: none;
        background: transparent;
        color: rgba(226, 232, 240, 0.65);
        font-size: 1.6rem;
        cursor: pointer;
        transition: color 0.2s ease;
      }

      .stats-close:hover {
        color: #fff;
      }

      .stats-input-row {
        display: flex;
        flex-direction: column;
        gap: 0.85rem;
      }

      .stats-language-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      .stats-language-row label {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.75rem;
        border-radius: 0.75rem;
        background: rgba(30, 41, 59, 0.55);
        border: 1px solid rgba(148, 163, 184, 0.25);
        color: var(--text-secondary);
        cursor: pointer;
      }

      .stats-language-row input[type="checkbox"] {
        accent-color: #38bdf8;
      }

      .stats-format-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
      }

      .stats-format-row label {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.75rem;
        border-radius: 0.75rem;
        background: rgba(30, 41, 59, 0.55);
        border: 1px solid rgba(148, 163, 184, 0.25);
        color: var(--text-secondary);
        cursor: pointer;
      }

      .stats-format-row input[type="radio"] {
        accent-color: #fb923c;
      }

      #stats-directory {
        flex: 1;
        min-width: 240px;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.6);
        color: var(--text-primary);
      }

      #stats-directory:focus {
        outline: 2px solid rgba(56, 189, 248, 0.55);
      }

      #stats-run {
        padding: 0.75rem 1.4rem;
        border-radius: 1rem;
        border: none;
        background: linear-gradient(135deg, #34d399, #22d3ee);
        color: #0f172a;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.25s ease;
      }

      #stats-run:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 30px rgba(56, 189, 248, 0.35);
      }

      .stats-message {
        min-height: 1.2rem;
        color: var(--text-secondary);
      }

      .stats-results {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1.25rem;
      }

      #stats-advanced-toggle {
        align-self: flex-start;
      }

      .stats-advanced {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      .stats-advanced[hidden] {
        display: none;
      }

      .stats-advanced label {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.4rem 0.75rem;
        border-radius: 0.75rem;
        background: rgba(30, 41, 59, 0.55);
        border: 1px solid rgba(148, 163, 184, 0.25);
        color: var(--text-secondary);
        cursor: pointer;
      }

      .stats-advanced input[type="checkbox"] {
        accent-color: #38bdf8;
      }

      .stats-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      .stats-secondary-button {
        padding: 0.65rem 1rem;
        border-radius: 0.9rem;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(30, 41, 59, 0.65);
        color: var(--text-primary);
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .stats-secondary-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.35);
      }

      .stats-card {
        background: rgba(30, 41, 59, 0.65);
        border-radius: 1.1rem;
        padding: 1.1rem;
        border: 1px solid rgba(148, 163, 184, 0.25);
        box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.15);
      }

      .stats-card h4 {
        margin: 0 0 0.75rem;
        font-size: 1.05rem;
        color: var(--text-primary);
      }

      .bar-chart {
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
      }

      .bar-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .bar-label {
        width: 80px;
        font-size: 0.85rem;
        color: var(--text-secondary);
        text-align: right;
      }

      .bar-track {
        flex: 1;
        height: 14px;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.12);
        overflow: hidden;
      }

      .bar-fill {
        height: 100%;
        border-radius: 999px;
        background: linear-gradient(90deg, #38bdf8, #a855f7);
      }

      .pie-chart {
        width: 180px;
        height: 180px;
        border-radius: 50%;
        background: rgba(148, 163, 184, 0.12);
        margin: 0 auto 1rem;
      }

      .pie-legend {
        display: flex;
        flex-direction: column;
        gap: 0.55rem;
      }

      .pie-legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-secondary);
        font-size: 0.9rem;
      }

      .pie-color {
        width: 14px;
        height: 14px;
        border-radius: 4px;
      }

      .stats-summary {
        display: grid;
        gap: 0.45rem;
        color: var(--text-secondary);
      }

      @media (max-width: 900px) {
        .control-grid {
          grid-template-columns: repeat(3, 70px);
          grid-template-rows: repeat(3, 70px);
        }
        .battlefield-shell {
          padding: 1.2rem;
        }
      }

      @media (max-width: 640px) {
        main {
          padding: 0 1rem 2rem;
        }
        .control-grid {
          grid-template-columns: repeat(3, 62px);
          grid-template-rows: repeat(3, 62px);
        }
        .duck-panel {
          width: 100px;
          height: 100px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>空域红包战线</h1>
      <p>在飞行战线上穿梭，驾驭坦克疾驰抢夺红包，按下按钮发起一轮轮空袭！</p>
    </header>

    <div id="start-overlay" class="overlay">
      <div class="overlay-card">
        <h2>飞行准备完毕</h2>
        <p>调准雷达，锁定红包坐标。点击“准备起飞”即刻进入空域，将红包收入囊中！</p>
        <button id="btn-start" class="action-button wide-button">准备起飞</button>
      </div>
    </div>
    <div id="rain-overlay"></div>

    <main>
      <section class="hud">
        <div class="hud-card">
          <div>剩余时间</div>
          <div class="status"><span id="time-left">--</span> 秒</div>
        </div>
        <div class="hud-card">
          <div>红包数量</div>
          <div class="status"><span id="count">--</span> 个</div>
        </div>
        <div class="hud-card">
          <div>红包金额</div>
          <div class="status"><span id="value">--</span> 元</div>
        </div>
        <div class="hud-card">
          <div>当前状态</div>
          <div class="status" id="game-status">等待启动</div>
        </div>
        <div class="hud-card">
          <div>触发体积</div>
          <div class="status">雷达圈即拾取范围</div>
        </div>
      </section>

      <section class="controls">
        <div class="control-helpers">
          <button id="btn-pause-top" class="action-button secondary">暂停</button>
          <button id="btn-reset-top" class="action-button wide-button">重新开始</button>
        </div>
      </section>

      <section class="battlefield-shell">
        <div class="battlefield">
          <div id="grid">
            <div class="envelope-layer" id="envelope-layer"></div>
          </div>
        </div>
      </section>

      <section class="controls">
        <div class="control-helpers">
          <button id="btn-rain" class="action-button alt">红包空袭</button>
          <button id="btn-pause" class="action-button secondary">暂停</button>
          <button id="btn-reset" class="action-button wide-button">重新部署</button>
        </div>
        <div class="controls-hint">提示：使用 W/A/S/D 或方向键可随时调整飞行轨迹。</div>
      </section>

      <section class="attendance-section" aria-labelledby="attendance-title">
        <div class="attendance-header">
          <div class="attendance-meta">
            <p id="attendance-title" class="attendance-label">考勤点名</p>
            <h3 id="attendance-student-name" class="attendance-name">等待抽取</h3>
            <p id="attendance-student-id" class="attendance-id">点击“下一位”抽取队员。</p>
          </div>
          <div class="attendance-nav">
            <button id="attendance-prev" type="button" class="attendance-prev">上一位</button>
            <button id="attendance-next" type="button" class="attendance-next">下一位</button>
          </div>
        </div>
        <div class="attendance-controls">
          <button id="attendance-start" type="button" class="attendance-primary">开始点名</button>
          <button id="attendance-end" type="button" class="attendance-secondary" disabled>结束本轮</button>
        </div>
        <p id="attendance-empty" class="attendance-empty">尚未加载任何学员。</p>
        <div id="attendance-actions" class="attendance-actions" hidden>
          <button type="button" class="attendance-action present" data-status="present">到</button>
          <button type="button" class="attendance-action leave" data-status="leave">请假</button>
          <button type="button" class="attendance-action absent" data-status="absent">缺勤</button>
        </div>
        <p id="attendance-message" class="attendance-message">点击“下一位”开始点名。</p>
        <div id="attendance-summary" class="attendance-summary" hidden>
          <h4>点名统计</h4>
          <div id="attendance-summary-message" class="attendance-message"></div>
          <div class="attendance-chart">
            <div class="attendance-bar-row">
              <span class="attendance-bar-label">到</span>
              <div class="attendance-bar-track">
                <div class="attendance-bar-fill present" data-status="present"></div>
              </div>
              <span class="attendance-bar-value" data-status-value="present">0 人</span>
            </div>
            <div class="attendance-bar-row">
              <span class="attendance-bar-label">请假</span>
              <div class="attendance-bar-track">
                <div class="attendance-bar-fill leave" data-status="leave"></div>
              </div>
              <span class="attendance-bar-value" data-status-value="leave">0 人</span>
            </div>
            <div class="attendance-bar-row">
              <span class="attendance-bar-label">缺勤</span>
              <div class="attendance-bar-track">
                <div class="attendance-bar-fill absent" data-status="absent"></div>
              </div>
              <span class="attendance-bar-value" data-status-value="absent">0 人</span>
            </div>
          </div>
        </div>
      </section>

      <section id="game-summary" class="summary" hidden>
        <h2>任务汇报</h2>
        <p id="summary-body">任务进行中，持续保持高能！</p>
      </section>
    </main>

    <footer>如果需要调整端口，可通过命令行或环境变量 TANK_GAME_PORT 设置。</footer>

    <div class="duck-panel" id="duck-helper-panel">
      <div class="duck-avatar">
        <img src="/static/duck.png" alt="Duck assistant" id="duck-helper" />
        <img
          id="duck-hat-layer"
          class="duck-layer hat active"
          data-selected-hat="hat1"
          src="/static/hat1.png"
          alt="Duck hat layer"
        />
        <img
          id="duck-cloth-layer"
          class="duck-layer cloth active"
          data-selected-cloth="cloth1"
          src="/static/cloth1.png"
          alt="Duck cloth layer"
        />
      </div>
    </div>
    <button id="duck-settings-button" class="duck-settings-button">设置</button>
    <div class="pause-floating">
      <button id="btn-pause-floating" aria-label="暂停或继续" title="暂停/继续">暂停</button>
    </div>
    <div class="stats-panel">
      <button id="stats-button" class="stats-button" aria-label="统计代码量">
        <img src="/static/duck2.jpg" alt="统计代码量" class="stats-icon" />
        <span class="stats-label">统计代码量</span>
      </button>
    </div>
    <div class="duck-settings-panel" id="duck-settings-panel">
      <div class="duck-settings-header">
        <h3>小鸭装扮设置</h3>
        <button id="duck-settings-close" class="duck-settings-close" aria-label="关闭设置">×</button>
      </div>
      <div class="duck-settings-section">
        <h4>帽子</h4>
        <div class="duck-settings-track" id="duck-hat-options"></div>
      </div>
      <div class="duck-settings-section">
        <h4>服饰</h4>
        <div class="duck-settings-track" id="duck-cloth-options"></div>
      </div>
    </div>
    <div id="duck-settings-overlay" class="duck-settings-overlay"></div>

    <div id="stats-dialog" class="stats-dialog" hidden>
      <div class="stats-dialog-card">
        <div class="stats-dialog-header">
          <h3>代码数据雷达</h3>
          <button id="stats-close" class="stats-close" aria-label="关闭">×</button>
        </div>
        <div class="stats-input-row">
          <input id="stats-directory" type="text" placeholder="输入要统计的目录，默认当前目录" />
          <div class="stats-language-row">
            <label><input type="checkbox" id="lang-c" value="c" checked />C</label>
            <label><input type="checkbox" id="lang-cpp" value="cpp" checked />C++</label>
            <label><input type="checkbox" id="lang-csharp" value="csharp" />C#</label>
            <label><input type="checkbox" id="lang-java" value="java" checked />Java</label>
            <label><input type="checkbox" id="lang-python" value="python" checked />Python</label>
          </div>
          <div class="stats-format-row">
            <span>保存格式：</span>
            <label><input type="radio" name="stats-format" value="none" checked />无</label>
            <label><input type="radio" name="stats-format" value="csv" />CSV</label>
            <label><input type="radio" name="stats-format" value="json" />JSON</label>
            <label><input type="radio" name="stats-format" value="xlsx" />XLSX</label>
          </div>
          <button id="stats-advanced-toggle" type="button" class="stats-secondary-button">高级选项</button>
          <div id="stats-advanced-panel" class="stats-advanced" hidden>
            <label><input type="checkbox" id="stats-include-blank" />输出空行数</label>
            <label><input type="checkbox" id="stats-include-comments" />输出注释行数</label>
          </div>
          <button id="stats-run" type="button">开始扫描</button>
        </div>
        <div id="stats-message" class="stats-message"></div>
        <div id="stats-results" class="stats-results" hidden>
          <div class="stats-card">
            <h4>语言代码量</h4>
            <div id="stats-bar-chart" class="bar-chart"></div>
          </div>
          <div class="stats-card">
            <h4>语言占比</h4>
            <div id="stats-pie-chart" class="pie-chart"></div>
            <div id="stats-pie-legend" class="pie-legend"></div>
          </div>
          <div class="stats-card">
            <h4>函数分析</h4>
            <div id="stats-function-summary" class="stats-summary"></div>
            <div class="stats-actions">
              <button id="stats-print-longest" class="stats-secondary-button">打印最长函数</button>
              <button id="stats-print-shortest" class="stats-secondary-button">打印最短函数</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  <div id="duck-dialog" class="duck-dialog" hidden>
      <div class="duck-dialog-card">
        <button id="duck-close" class="duck-close" aria-label="关闭">×</button>
        <h3>飞行助手小鸭上线</h3>
        <div class="duck-dialog-body">
          <input id="duck-input" type="text" placeholder="输入命令，例如“红包雨”" />
          <button id="duck-send">发送</button>
        </div>
        <p id="duck-response" class="duck-response"></p>
      </div>
    </div>
    <div id="stats-function-modal" class="stats-modal">
      <div class="stats-modal-card">
        <button id="stats-modal-close" class="stats-modal-close" aria-label="关闭">×</button>
        <h4 id="stats-modal-title">函数信息</h4>
        <p id="stats-modal-message"></p>
      </div>
    </div>

    <script>
      const CELL_SIZE = 30;

      const timeLeftEl = document.getElementById("time-left");
      const countEl = document.getElementById("count");
      const valueEl = document.getElementById("value");
      const gridEl = document.getElementById("grid");
      const envelopeLayer = document.getElementById("envelope-layer");
      const statusEl = document.getElementById("game-status");
      const summaryEl = document.getElementById("game-summary");
      const summaryBodyEl = document.getElementById("summary-body");

      const startOverlay = document.getElementById("start-overlay");
      const startButton = document.getElementById("btn-start");
      const resetButton = document.getElementById("btn-reset");
      const rainButton = document.getElementById("btn-rain");
      const pauseButton = document.getElementById("btn-pause");
      const topPauseButton = document.getElementById("btn-pause-top");
      const topResetButton = document.getElementById("btn-reset-top");
      const floatingPauseButton = document.getElementById("btn-pause-floating");
      const rainOverlay = document.getElementById("rain-overlay");

      const attendanceNameEl = document.getElementById("attendance-student-name");
      const attendanceIdEl = document.getElementById("attendance-student-id");
      const attendancePrevButton = document.getElementById("attendance-prev");
      const attendanceNextButton = document.getElementById("attendance-next");
      const attendanceStartButton = document.getElementById("attendance-start");
      const attendanceEndButton = document.getElementById("attendance-end");
      const attendanceMessageEl = document.getElementById("attendance-message");
      const attendanceEmptyEl = document.getElementById("attendance-empty");
      const attendanceActionsEl = document.getElementById("attendance-actions");
      const attendanceSummaryEl = document.getElementById("attendance-summary");
      const attendanceSummaryMessage = document.getElementById("attendance-summary-message");
      const attendanceActionButtons = Array.from(document.querySelectorAll(".attendance-action"));
      const attendanceBarFills = document.querySelectorAll(".attendance-bar-fill");
      const attendanceBarValues = document.querySelectorAll(".attendance-bar-value");

      const duckPanel = document.getElementById("duck-helper-panel");
      const duckBaseImage = document.getElementById("duck-helper");
      const duckDialog = document.getElementById("duck-dialog");
      const duckClose = document.getElementById("duck-close");
      const duckInput = document.getElementById("duck-input");
      const duckSend = document.getElementById("duck-send");
      const duckResponse = document.getElementById("duck-response");
      const duckHatLayer = document.getElementById("duck-hat-layer");
      const duckClothLayer = document.getElementById("duck-cloth-layer");
      const duckSettingsButton = document.getElementById("duck-settings-button");
      const duckSettingsPanel = document.getElementById("duck-settings-panel");
      const duckSettingsOverlay = document.getElementById("duck-settings-overlay");
      const duckSettingsClose = document.getElementById("duck-settings-close");
      const duckHatOptions = document.getElementById("duck-hat-options");
      const duckClothOptions = document.getElementById("duck-cloth-options");
      const statsButton = document.getElementById("stats-button");
      const statsDialog = document.getElementById("stats-dialog");
      const statsClose = document.getElementById("stats-close");
      const statsDirectory = document.getElementById("stats-directory");
      const statsRun = document.getElementById("stats-run");
      const statsLanguageChecks = {
        c: document.getElementById("lang-c"),
        cpp: document.getElementById("lang-cpp"),
        csharp: document.getElementById("lang-csharp"),
        java: document.getElementById("lang-java"),
        python: document.getElementById("lang-python"),
      };
      const statsMessage = document.getElementById("stats-message");
      const statsResults = document.getElementById("stats-results");
      const statsBarChart = document.getElementById("stats-bar-chart");
      const statsPieChart = document.getElementById("stats-pie-chart");
      const statsPieLegend = document.getElementById("stats-pie-legend");
      const statsFunctionSummary = document.getElementById("stats-function-summary");
      const statsAdvancedToggle = document.getElementById("stats-advanced-toggle");
      const statsAdvancedPanel = document.getElementById("stats-advanced-panel");
      const statsIncludeBlank = document.getElementById("stats-include-blank");
      const statsIncludeComments = document.getElementById("stats-include-comments");
      const statsFormatRadios = Array.from(document.querySelectorAll('input[name="stats-format"]'));
      const statsPrintLongest = document.getElementById("stats-print-longest");
      const statsPrintShortest = document.getElementById("stats-print-shortest");
      const statsFunctionModal = document.getElementById("stats-function-modal");
      const statsModalTitle = document.getElementById("stats-modal-title");
      const statsModalMessage = document.getElementById("stats-modal-message");
      const statsModalClose = document.getElementById("stats-modal-close");

      const directionButtons = {
        up: { disabled: true },
        down: { disabled: true },
        left: { disabled: true },
        right: { disabled: true },
      };

      const sizeNameMap = {
        Small: "小",
        Medium: "中",
        Large: "大",
      };
      const duckDefaultGreeting = "您好，有什么可以帮助你";
      const duckStorageKeys = {
        hat: "duck_hat_id",
        cloth: "duck_cloth_id",
      };

      class CostumePiece {
        constructor(id, name, imageUrl) {
          this.id = id;
          this.name = name;
          this.imageUrl = imageUrl;
        }
      }

      class Hat extends CostumePiece {
        constructor(id, name, imageUrl) {
          super(id, name, imageUrl);
          this.type = "hat";
        }
      }

      class Cloth extends CostumePiece {
        constructor(id, name, imageUrl) {
          super(id, name, imageUrl);
          this.type = "cloth";
        }
      }

      class Costume {
        constructor() {
          this.hat = null;
          this.cloth = null;
        }
        setHat(piece) {
          this.hat = piece ?? null;
        }
        setCloth(piece) {
          this.cloth = piece ?? null;
        }
        getHat() {
          return this.hat;
        }
        getCloth() {
          return this.cloth;
        }
        clearHat() {
          this.hat = null;
        }
        clearCloth() {
          this.cloth = null;
        }
      }

      class CartoonDuck {
        constructor(baseImage, hatLayer, clothLayer) {
          this.baseImage = baseImage;
          this.hatLayer = hatLayer;
          this.clothLayer = clothLayer;
          this.costume = new Costume();
        }
        applyHat(hat) {
          this.costume.setHat(hat);
          this.refreshLayers();
        }
        applyCloth(cloth) {
          this.costume.setCloth(cloth);
          this.refreshLayers();
        }
        getCostume() {
          return this.costume;
        }
        refreshLayers() {
          if (this.hatLayer) {
            if (this.costume.hat) {
              this.hatLayer.src = this.costume.hat.imageUrl;
              this.hatLayer.classList.add("active");
            } else {
              this.hatLayer.removeAttribute("src");
              this.hatLayer.classList.remove("active");
            }
          }
          if (this.clothLayer) {
            if (this.costume.cloth) {
              this.clothLayer.src = this.costume.cloth.imageUrl;
              this.clothLayer.classList.add("active");
            } else {
              this.clothLayer.removeAttribute("src");
              this.clothLayer.classList.remove("active");
            }
          }
        }
      }

      class DuckUIManager {
        constructor(options) {
          this.duckPanel = options.duckPanel;
          this.settingsPanel = options.settingsPanel;
          this.settingsOverlay = options.settingsOverlay;
          this.hatOptionsContainer = options.hatOptionsContainer;
          this.clothOptionsContainer = options.clothOptionsContainer;
          this.cartoonDuck = options.cartoonDuck;
          this.hats = options.hats || [];
          this.clothes = options.clothes || [];
          this.hatLayer = options.hatLayer;
          this.clothLayer = options.clothLayer;

          const datasetHat = this.hatLayer?.dataset.selectedHat || null;
          const datasetCloth = this.clothLayer?.dataset.selectedCloth || null;
          const storedHat = this.#loadFromStorage(duckStorageKeys.hat);
          const storedCloth = this.#loadFromStorage(duckStorageKeys.cloth);

          this.currentHatId = storedHat || datasetHat || "none";
          this.currentClothId = storedCloth || datasetCloth || "none";

          this.renderHatOptions(this.hats);
          this.renderClothOptions(this.clothes);

          const initialHat =
            this.hats.find((item) => item.id === this.currentHatId) || null;
          const initialCloth =
            this.clothes.find((item) => item.id === this.currentClothId) || null;

          this.setHat(initialHat);
          this.setCloth(initialCloth);
        }

        #loadFromStorage(key) {
          try {
            const value = window.localStorage.getItem(key);
            return value && value.length > 0 ? value : null;
          } catch {
            return null;
          }
        }

        #saveToStorage(key, value) {
          try {
            if (value && value.length > 0) {
              window.localStorage.setItem(key, value);
            } else {
              window.localStorage.removeItem(key);
            }
          } catch {
            // ignore storage errors
          }
        }

        openSettings() {
          if (this.settingsPanel && this.settingsOverlay) {
            this.settingsPanel.classList.add("open");
            this.settingsOverlay.classList.add("visible");
          }
        }

        closeSettings() {
          if (this.settingsPanel && this.settingsOverlay) {
            this.settingsPanel.classList.remove("open");
            this.settingsOverlay.classList.remove("visible");
          }
        }

        highlightSelection(container, activeId) {
          if (!container) {
            return;
          }
          container.querySelectorAll(".duck-settings-option").forEach((button) => {
            if (button.dataset.id === activeId) {
              button.classList.add("active");
            } else {
              button.classList.remove("active");
            }
          });
        }

        setHat(hat) {
          this.currentHatId = hat ? hat.id : "none";
          this.cartoonDuck.applyHat(hat || null);
          if (this.hatLayer) {
            if (hat) {
              this.hatLayer.dataset.selectedHat = hat.id;
            } else {
              delete this.hatLayer.dataset.selectedHat;
            }
          }
          this.highlightSelection(this.hatOptionsContainer, this.currentHatId);
          this.#saveToStorage(
            duckStorageKeys.hat,
            hat ? hat.id : "",
          );
        }

        setCloth(cloth) {
          this.currentClothId = cloth ? cloth.id : "none";
          this.cartoonDuck.applyCloth(cloth || null);
          if (this.clothLayer) {
            if (cloth) {
              this.clothLayer.dataset.selectedCloth = cloth.id;
            } else {
              delete this.clothLayer.dataset.selectedCloth;
            }
          }
          this.highlightSelection(this.clothOptionsContainer, this.currentClothId);
          this.#saveToStorage(
            duckStorageKeys.cloth,
            cloth ? cloth.id : "",
          );
        }

        renderHatOptions(hats) {
          this.#renderOptions(hats, this.hatOptionsContainer, "hat");
        }

        renderClothOptions(clothes) {
          this.#renderOptions(clothes, this.clothOptionsContainer, "cloth");
        }

        #renderOptions(items, container, type) {
          if (!container) {
            return;
          }
          container.innerHTML = "";
          const noneLabel = type === "hat" ? "无帽子" : "无服饰";
          const noneButton = document.createElement("button");
          noneButton.type = "button";
          noneButton.className = "duck-settings-option";
          noneButton.dataset.id = "none";
          noneButton.innerHTML = `<span>${noneLabel}</span>`;
          noneButton.addEventListener("click", () => {
            if (type === "hat") {
              this.setHat(null);
            } else {
              this.setCloth(null);
            }
          });
          container.appendChild(noneButton);

          items.forEach((item) => {
            const button = document.createElement("button");
            button.type = "button";
            button.className = "duck-settings-option";
            button.dataset.id = item.id;
            const img = document.createElement("img");
            img.src = item.imageUrl;
            img.alt = item.name;
            const label = document.createElement("span");
            label.textContent = item.name;
            button.append(img, label);
            button.addEventListener("click", () => {
              if (type === "hat") {
                this.setHat(item);
              } else {
                this.setCloth(item);
              }
            });
            container.appendChild(button);
          });
        }
      }

      let refreshTimer = null;
      let gameStarted = false;
      let gameFinished = false;
      let gamePaused = false;
      let rainInProgress = false;
      let attendanceCurrentStudent = null;
      let attendanceBusy = false;
      let attendanceSessionActive = false;
      let attendanceRoundCompleted = false;
      let attendanceRoster = [];
      let attendanceHasServedStudent = false;
      let attendanceSubmissionInProgress = false;
      const attendanceRecords = new Map();
      const attendanceResults = { present: 0, leave: 0, absent: 0 };

      const RAIN_DROP_COUNT = 28;
      const RAIN_ANIMATION_DURATION = 3600;

      const gridState = {
        width: 0,
        height: 0,
        heightPx: 0,
        envelopes: new Map(),
        tankOverlay: null,
      };
      const FALL_SPEED_MIN = 40;
      const FALL_SPEED_MAX = 120;

      function ensureBattlefieldDimensions(width, height) {
        if (gridState.width === width && gridState.height === height) {
          return;
        }

        gridState.width = width;
        gridState.height = height;

        const widthPx = width * CELL_SIZE;
        const heightPx = height * CELL_SIZE;
        gridEl.style.width = `${widthPx}px`;
        gridEl.style.height = `${heightPx}px`;
        envelopeLayer.style.width = `${widthPx}px`;
        envelopeLayer.style.height = `${heightPx}px`;
        gridState.heightPx = heightPx;

        if (!gridState.tankOverlay) {
          const tank = document.createElement("div");
          tank.className = "tank-overlay";
          const body = document.createElement("div");
          body.className = "tank-body";
          const img = document.createElement("img");
          img.src = "/static/tank.jpg";
          img.alt = "玩家坦克";
          body.appendChild(img);
          tank.appendChild(body);
          gridEl.appendChild(tank);
          gridState.tankOverlay = tank;
        }
      }

      function updateTankPosition(tank) {
        if (!tank) {
          if (gridState.tankOverlay) {
            gridState.tankOverlay.style.display = "none";
          }
          return;
        }
        if (!gridState.tankOverlay) {
          return;
        }
        gridState.tankOverlay.style.display = "flex";
        const x = tank.x * CELL_SIZE;
        const y = tank.y * CELL_SIZE;
        gridState.tankOverlay.style.transform = `translate3d(${x}px, ${y}px, 0)`;
      }

      function createEnvelopeNode(size) {
        const node = document.createElement("div");
        node.className = "envelope";
        node.dataset.size = size ?? "Small";
        node.style.willChange = "transform";
        const valueSpan = document.createElement("span");
        valueSpan.className = "envelope-value";
        node.appendChild(valueSpan);
        return node;
      }

      function finalizeEnvelopeRemoval(id) {
        const state = gridState.envelopes.get(id);
        if (!state) {
          return;
        }
        state.element.remove();
        gridState.envelopes.delete(id);
      }

      function scheduleEnvelopeRemoval(id) {
        const state = gridState.envelopes.get(id);
        if (!state || state.removing) {
          return;
        }
        const bottom =
          gridState.heightPx > 0
            ? gridState.heightPx - CELL_SIZE
            : gridState.height > 0 ? (gridState.height - 1) * CELL_SIZE : 0;
        state.removing = true;
        state.targetY = bottom;
        const extraSpeed = Math.max(state.velocity ?? FALL_SPEED_MIN, FALL_SPEED_MIN * 1.4);
        state.velocity = extraSpeed;
      }

      function applyEnvelopeUpdates(envelopes) {
        const activeIds = new Set();
        const maxX =
          gridState.widthPx > 0
            ? gridState.widthPx - CELL_SIZE
            : gridState.width > 0 ? (gridState.width - 1) * CELL_SIZE : 0;
        const maxY =
          gridState.heightPx > 0
            ? gridState.heightPx - CELL_SIZE
            : gridState.height > 0 ? (gridState.height - 1) * CELL_SIZE : 0;

        envelopes.forEach((envelope) => {
          const envelopeId = envelope.id ?? `${envelope.x ?? 0}-${envelope.y ?? 0}`;
          activeIds.add(envelopeId);
          let state = gridState.envelopes.get(envelopeId);
          if (!state) {
            const node = createEnvelopeNode(envelope.size);
            const initialY = -CELL_SIZE * (0.5 + Math.random() * 2);
            const velocity =
              FALL_SPEED_MIN + Math.random() * (FALL_SPEED_MAX - FALL_SPEED_MIN);
            state = {
              element: node,
              x: Math.max(0, Math.min(maxX, Math.round(envelope.x ?? 0) * CELL_SIZE)),
              y: initialY,
              targetY: Math.max(
                0,
                Math.min(maxY, Math.round(envelope.y ?? 0) * CELL_SIZE),
              ),
              velocity,
              removing: false,
            };
            gridState.envelopes.set(envelopeId, state);
            envelopeLayer.appendChild(node);
          }

          const node = state.element;
          node.dataset.size = envelope.size ?? "Small";
          const valueSpan = node.firstElementChild;
          if (valueSpan) {
            valueSpan.textContent = envelope.value ?? 0;
          }
          node.title = `红包面额：${envelope.value ?? 0}（${sizeNameMap[envelope.size] ?? ""}）`;

          const clampedX = Math.max(
            0,
            Math.min(maxX, Math.round(envelope.x ?? 0) * CELL_SIZE),
          );
          state.x = clampedX;
          state.targetY = Math.max(
            0,
            Math.min(maxY, Math.round(envelope.y ?? 0) * CELL_SIZE),
          );
          state.removing = false;
          state.element.style.transform = `translate3d(${state.x}px, ${state.y}px, 0)`;
        });

        const toRemove = [];
        gridState.envelopes.forEach((_, id) => {
          if (!activeIds.has(id)) {
            toRemove.push(id);
          }
        });
        toRemove.forEach((id) => scheduleEnvelopeRemoval(id));
      }

      let lastFrameTime = performance.now();

      function animationFrame(timestamp) {
        const deltaSeconds = Math.min(0.05, (timestamp - lastFrameTime) / 1000);
        lastFrameTime = timestamp;

        const toFinalize = [];
        gridState.envelopes.forEach((state, id) => {
          if (state.targetY === undefined) {
            state.targetY = (gridState.heightPx || CELL_SIZE * (gridState.height || 20)) - CELL_SIZE;
          }

          if (state.y < state.targetY) {
            state.y = Math.min(state.y + state.velocity * deltaSeconds, state.targetY);
          } else if (state.y > state.targetY) {
            state.y = state.targetY;
          }

          const limit =
            gridState.heightPx > 0
              ? gridState.heightPx + CELL_SIZE
              : CELL_SIZE * (gridState.height || 20);

          if (state.y > limit) {
            toFinalize.push(id);
            return;
          }

          if (state.removing && state.y >= state.targetY - 0.01) {
            state.y = state.targetY;
            state.element.style.transform = `translate3d(${state.x}px, ${state.y}px, 0)`;
            toFinalize.push(id);
            return;
          }
          state.element.style.transform = `translate3d(${state.x}px, ${state.y}px, 0)`;
        });
        toFinalize.forEach((id) => finalizeEnvelopeRemoval(id));

        requestAnimationFrame(animationFrame);
      }

      requestAnimationFrame((timestamp) => {
        lastFrameTime = timestamp;
        requestAnimationFrame(animationFrame);
      });

      function setControlsEnabled(_enabled) {}

      function startPolling() {
        if (refreshTimer) {
          clearInterval(refreshTimer);
        }
        refreshTimer = setInterval(() => refreshState(), 450);
      }

      function stopPolling() {
        if (refreshTimer) {
          clearInterval(refreshTimer);
          refreshTimer = null;
        }
      }

      function delay(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      function setHudPlaceholders() {
        timeLeftEl.textContent = "--";
        countEl.textContent = "0";
        valueEl.textContent = "0";
      }

      function initializeUI() {
        setControlsEnabled(false);
        resetButton.disabled = true;
        pauseButton.disabled = true;
        if (topResetButton) topResetButton.disabled = true;
        if (topPauseButton) topPauseButton.disabled = true;
        if (floatingPauseButton) floatingPauseButton.disabled = true;
        rainButton.disabled = true;
        statusEl.textContent = "等待开始";
      }

      initializeUI();

      function setAttendanceMessage(message, variant = "info") {
        if (!attendanceMessageEl) {
          return;
        }
        attendanceMessageEl.textContent = message;
        attendanceMessageEl.classList.remove("success", "error");
        if (variant === "success") {
          attendanceMessageEl.classList.add("success");
        } else if (variant === "error") {
          attendanceMessageEl.classList.add("error");
        }
      }

      function resetAttendanceData() {
        attendanceRecords.clear();
        attendanceResults.present = 0;
        attendanceResults.leave = 0;
        attendanceResults.absent = 0;
        attendanceRoundCompleted = false;
        attendanceHasServedStudent = false;
        if (attendanceSummaryEl) {
          attendanceSummaryEl.hidden = true;
        }
        setAttendanceSummaryMessage("");
        renderAttendanceChart();
      }

      function setAttendanceSummaryMessage(text) {
        if (attendanceSummaryMessage) {
          attendanceSummaryMessage.textContent = text || "";
        }
      }

      function updateAttendanceControls() {
        const hasStudent = Boolean(attendanceCurrentStudent);
        if (attendanceActionsEl) {
          if (hasStudent) {
            attendanceActionsEl.removeAttribute("hidden");
          } else {
            attendanceActionsEl.setAttribute("hidden", "hidden");
          }
        }
        if (attendanceEmptyEl) {
          if (hasStudent) {
            attendanceEmptyEl.setAttribute("hidden", "hidden");
          } else {
            attendanceEmptyEl.removeAttribute("hidden");
          }
        }
        attendanceActionButtons.forEach((button) => {
          button.disabled =
            !hasStudent || attendanceBusy || !attendanceSessionActive ||
            attendanceSubmissionInProgress;
        });
        if (attendanceNextButton) {
          attendanceNextButton.disabled =
            attendanceBusy || !attendanceSessionActive || attendanceRoundCompleted ||
            attendanceSubmissionInProgress;
        }
        if (attendancePrevButton) {
          attendancePrevButton.disabled =
            attendanceBusy || !attendanceSessionActive || !attendanceHasServedStudent ||
            attendanceSubmissionInProgress;
        }
        if (attendanceStartButton) {
          attendanceStartButton.disabled =
            attendanceSessionActive || attendanceRoster.length === 0 || attendanceSubmissionInProgress;
        }
        if (attendanceEndButton) {
          attendanceEndButton.disabled = !attendanceSessionActive || attendanceSubmissionInProgress;
        }
      }

      function updateAttendanceStudent(student) {
        attendanceCurrentStudent = student;
        if (attendanceNameEl) {
          attendanceNameEl.textContent = student
            ? student.name || "未命名学员"
            : "等待抽取";
        }
        if (attendanceIdEl) {
          attendanceIdEl.textContent = student
            ? `学号 ${student.id ?? "--"}`
            : "点击“下一位”抽取队员。";
        }
        if (student && attendanceSessionActive) {
          speakStudentName(student.name || student.id || "下一位同学");
        }
        updateAttendanceControls();
      }

      function speakStudentName(name) {
        if (!window.speechSynthesis) {
          return;
        }
        const utterance = new SpeechSynthesisUtterance(name || "");
        utterance.lang = "zh-CN";
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
      }

      function getAttendanceStatusLabel(status) {
        switch (status) {
          case "present":
            return "到";
          case "leave":
            return "请假";
          case "absent":
            return "缺勤";
          default:
            return status;
        }
      }

      async function loadAttendanceRoster() {
        try {
          const response = await fetch("/attendance/roster");
          if (!response.ok) {
            throw new Error("加载点名名单失败");
          }
          const data = await response.json();
          if (data.success && Array.isArray(data.students)) {
            attendanceRoster = data.students;
            if (attendanceEmptyEl) {
              attendanceEmptyEl.textContent =
                attendanceRoster.length === 0
                  ? "名单为空，请先在数据库中添加学员。"
                  : "点击“开始点名”并抽取下一位。";
            }
          } else {
            throw new Error(data.error || "加载名单失败");
          }
        } catch (error) {
          console.error(error);
          attendanceRoster = [];
          if (attendanceEmptyEl) {
            attendanceEmptyEl.textContent = "无法加载名单，请稍后重试。";
          }
        } finally {
          updateAttendanceControls();
        }
      }

      function renderAttendanceChart() {
        if (!attendanceSummaryEl) {
          return;
        }
        const total = attendanceRoster.length || Math.max(...Object.values(attendanceResults), 1);
        attendanceBarFills.forEach((bar) => {
          const status = bar.dataset.status;
          const count = attendanceResults[status] ?? 0;
          const width = total > 0 ? Math.min(100, (count / total) * 100) : 0;
          bar.style.width = `${width}%`;
        });
        attendanceBarValues.forEach((label) => {
          const status = label.dataset.statusValue;
          const count = attendanceResults[status] ?? 0;
          label.textContent = `${count} 人`;
        });
      }

      function recordAttendanceResult(studentId, status) {
        if (!studentId) {
          return;
        }
        const previous = attendanceRecords.get(studentId);
        if (previous === status) {
          return;
        }
        if (previous) {
          attendanceResults[previous] = Math.max(0, attendanceResults[previous] - 1);
        }
        attendanceRecords.set(studentId, status);
        if (typeof attendanceResults[status] === "number") {
          attendanceResults[status] += 1;
        }
        renderAttendanceChart();
      }

      async function submitAttendanceRecords() {
        const entries = Array.from(attendanceRecords.entries());
        if (entries.length === 0) {
          return;
        }
        for (const [studentId, status] of entries) {
          const params = new URLSearchParams();
          params.set("studentId", studentId);
          params.set("status", status);
          const response = await fetch("/attendance/mark", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: params.toString(),
          });
          if (!response.ok) {
            let message = "提交点名数据失败";
            try {
              const errorBody = await response.json();
              if (errorBody && errorBody.error) {
                message = errorBody.error;
              }
            } catch {
              const fallback = await response.text();
              if (fallback) {
                message = fallback;
              }
            }
            throw new Error(message);
          }
          const result = await response.json();
          if (!result.success) {
            throw new Error(result.error || "提交点名数据失败");
          }
        }
      }

      function completeAttendanceRound() {
        attendanceRoundCompleted = true;
        if (attendanceSummaryEl) {
          attendanceSummaryEl.hidden = false;
        }
        const total = attendanceRecords.size;
        setAttendanceSummaryMessage(
          total > 0
            ? `本轮共点名 ${total} 人，可使用“上一位”检查并点击“结束本轮”提交。`
            : "本轮未记录任何点名结果。",
        );
        setAttendanceMessage("本轮点名完成，请确认后点击“结束本轮”提交。", "success");
        updateAttendanceControls();
      }

      function startAttendanceSession() {
        if (attendanceRoster.length === 0) {
          setAttendanceMessage("名单为空，无法开始点名。", "error");
          return;
        }
        attendanceSessionActive = true;
        resetAttendanceData();
        updateAttendanceStudent(null);
        setAttendanceMessage("点名已开始，点击“下一位”抽取学员。", "info");
        attendanceHasServedStudent = false;
        updateAttendanceControls();
        fetchNextAttendanceStudent();
      }

      async function endAttendanceSession() {
        if (attendanceSubmissionInProgress) {
          setAttendanceMessage("正在提交，请稍候...", "info");
          return;
        }
        if (!attendanceSessionActive && attendanceRecords.size === 0) {
          setAttendanceMessage("本轮尚未开始，无需结束。", "info");
          return;
        }
        if (attendanceRecords.size === 0) {
          setAttendanceMessage("还没有记录任何学员，请先点名后再提交。", "error");
          return;
        }
        attendanceSubmissionInProgress = true;
        updateAttendanceControls();
        setAttendanceMessage("正在提交本轮点名结果...", "info");
        try {
          await submitAttendanceRecords();
          attendanceSessionActive = false;
          attendanceRoundCompleted = true;
          attendanceHasServedStudent = false;
          if (attendanceSummaryEl) {
            attendanceSummaryEl.hidden = false;
          }
          setAttendanceSummaryMessage("本轮已结束，结果已提交。");
          renderAttendanceChart();
          setAttendanceMessage("本轮考勤已提交。", "success");
        } catch (error) {
          console.error(error);
          setAttendanceMessage(error.message || "提交失败，请稍后重试。", "error");
          attendanceSubmissionInProgress = false;
          updateAttendanceControls();
          return;
        }
        attendanceSubmissionInProgress = false;
        updateAttendanceControls();
      }

      async function fetchNextAttendanceStudent() {
        if (!attendanceNextButton || attendanceBusy) {
          return;
        }
        if (!attendanceSessionActive) {
          setAttendanceMessage("请先点击“开始点名”。", "error");
          return;
        }
        attendanceBusy = true;
        updateAttendanceControls();
        setAttendanceMessage("正在抽取下一位队员...", "info");
        try {
          const response = await fetch("/attendance/next");
          if (!response.ok) {
            throw new Error("attendance next failed");
          }
          const data = await response.json();
          if (!data.success) {
            throw new Error(data.error || "无法获取下一位队员");
          }
          if (data.empty) {
            updateAttendanceStudent(null);
            setAttendanceMessage("当前没有任何学员，请在数据库中添加记录。", "info");
            return;
          }
          updateAttendanceStudent(data.student);
          const label = data.student?.name || data.student?.id || "该学员";
          setAttendanceMessage(`请记录 ${label} 的状态。`, "info");
          attendanceHasServedStudent = true;
        } catch (error) {
          console.error(error);
          setAttendanceMessage("获取下一位队员失败，请稍后重试。", "error");
        } finally {
          attendanceBusy = false;
          updateAttendanceControls();
        }
      }

      async function fetchPreviousAttendanceStudent() {
        if (!attendancePrevButton || attendanceBusy) {
          return;
        }
        if (!attendanceSessionActive) {
          setAttendanceMessage("请先点击“开始点名”。", "error");
          return;
        }
        if (!attendanceHasServedStudent) {
          setAttendanceMessage("还没有点过名，无法回退。", "error");
          return;
        }
        attendanceBusy = true;
        updateAttendanceControls();
        setAttendanceMessage("回退上一位队员...", "info");
        try {
          const response = await fetch("/attendance/previous");
          if (!response.ok) {
            throw new Error("attendance previous failed");
          }
          const data = await response.json();
          if (!data.success) {
            throw new Error(data.error || "无法回退上一位队员");
          }
          if (data.empty) {
            setAttendanceMessage("名单为空，无法回退。", "info");
            return;
          }
          updateAttendanceStudent(data.student);
          attendanceHasServedStudent = true;
          const label = data.student?.name || data.student?.id || "该学员";
          const recordedStatus = attendanceRecords.get(data.student?.id ?? "");
          if (recordedStatus) {
            const recordedLabel = getAttendanceStatusLabel(recordedStatus);
            setAttendanceMessage(`回到 ${label}（当前记录：${recordedLabel}），可重新标记。`, "info");
          } else {
            setAttendanceMessage(`回到 ${label}，可重新标记。`, "info");
          }
        } catch (error) {
          console.error(error);
          setAttendanceMessage("获取上一位队员失败，请稍后重试。", "error");
        } finally {
          attendanceBusy = false;
          updateAttendanceControls();
        }
      }

      async function submitAttendance(status) {
        if (!attendanceCurrentStudent || attendanceBusy) {
          return;
        }
        if (!attendanceSessionActive) {
          setAttendanceMessage("请先点击“开始点名”。", "error");
          return;
        }
        attendanceBusy = true;
        updateAttendanceControls();
        const label =
          attendanceCurrentStudent.name || attendanceCurrentStudent.id || "该学员";
        const statusLabel = getAttendanceStatusLabel(status);
        recordAttendanceResult(attendanceCurrentStudent.id, status);
        setAttendanceMessage(`${label} 已标记为${statusLabel}（提交前可随时修改）。`, "success");
        attendanceBusy = false;
        updateAttendanceControls();
        if (
          attendanceRoster.length > 0 &&
          attendanceRecords.size >= attendanceRoster.length &&
          !attendanceRoundCompleted
        ) {
          completeAttendanceRound();
          return;
        }
        if (!attendanceRoundCompleted) {
          await fetchNextAttendanceStudent();
        }
      }

      updateAttendanceStudent(null);
      setAttendanceMessage("加载名单中...", "info");
      loadAttendanceRoster();

      const interactiveButtons = Array.from(
        document.querySelectorAll(
          ".action-button, .attendance-action, .attendance-prev, .attendance-next, .attendance-primary, .attendance-secondary",
        ),
      );
      let pointerX = 0;
      let pointerY = 0;
      let pointerScheduled = false;

      const hatCatalog = [
        new Hat("hat1", "极光机师帽", "/static/hat1.png"),
        new Hat("hat2", "晨曦指挥帽", "/static/hat2.png"),
        new Hat("hat3", "暮色巡航帽", "/static/hat3.png"),
      ];
      const clothCatalog = [
        new Cloth("cloth1", "深空礼服", "/static/cloth1.png"),
        new Cloth("cloth2", "流火战甲", "/static/cloth2.png"),
        new Cloth("cloth3", "翠羽飞行服", "/static/cloth3.png"),
      ];
      const cartoonDuck = new CartoonDuck(duckBaseImage, duckHatLayer, duckClothLayer);
      const duckUiManager = new DuckUIManager({
        duckPanel,
        settingsPanel: duckSettingsPanel,
        settingsOverlay: duckSettingsOverlay,
        hatOptionsContainer: duckHatOptions,
        clothOptionsContainer: duckClothOptions,
        cartoonDuck,
        hats: hatCatalog,
        clothes: clothCatalog,
        hatLayer: duckHatLayer,
        clothLayer: duckClothLayer,
      });

      function applyButtonProximityEffects() {
        interactiveButtons.forEach((button) => {
          if (button.disabled) {
            button.style.setProperty("--hover-scale", 1);
            button.style.setProperty("--hover-glow", 0);
            return;
          }
          const rect = button.getBoundingClientRect();
          const dx = pointerX - (rect.left + rect.width / 2);
          const dy = pointerY - (rect.top + rect.height / 2);
          const distance = Math.sqrt(dx * dx + dy * dy);
          const maxDistance = 220;
          const proximity = Math.max(0, (maxDistance - distance) / maxDistance);
          const scale = 1 + proximity * 0.14;
          button.style.setProperty("--hover-scale", scale.toFixed(3));
          button.style.setProperty("--hover-glow", proximity.toFixed(3));
        });
        pointerScheduled = false;
      }

      document.addEventListener("mousemove", (event) => {
        pointerX = event.clientX;
        pointerY = event.clientY;
        if (!pointerScheduled) {
          pointerScheduled = true;
          requestAnimationFrame(applyButtonProximityEffects);
        }
      });

      startButton.addEventListener("click", startGame);
      resetButton.addEventListener("click", resetGame);
      if (topResetButton) {
        topResetButton.addEventListener("click", resetGame);
      }
      rainButton.addEventListener("click", triggerRain);
      pauseButton.addEventListener("click", togglePause);
      if (topPauseButton) {
        topPauseButton.addEventListener("click", togglePause);
      }
      if (floatingPauseButton) {
        floatingPauseButton.addEventListener("click", togglePause);
      }

      duckPanel.addEventListener("click", openDuckDialog);
      duckSettingsButton.addEventListener("click", () => duckUiManager.openSettings());
      duckSettingsClose.addEventListener("click", () => duckUiManager.closeSettings());
      duckSettingsOverlay.addEventListener("click", () => duckUiManager.closeSettings());
      duckClose.addEventListener("click", closeDuckDialog);
      duckDialog.addEventListener("click", (event) => {
        if (event.target === duckDialog) {
          closeDuckDialog();
        }
      });
      duckSend.addEventListener("click", submitDuckCommand);
      duckInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          submitDuckCommand();
        }
      });
      statsButton.addEventListener("click", openStatsDialog);
      statsClose.addEventListener("click", closeStatsDialog);
      statsDialog.addEventListener("click", (event) => {
        if (event.target === statsDialog) {
          closeStatsDialog();
        }
      });
      statsRun.addEventListener("click", runStats);
      statsDirectory.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          runStats();
        }
      });
      statsPrintLongest.addEventListener("click", () => printFunctionSummary("longest"));
      statsPrintShortest.addEventListener("click", () => printFunctionSummary("shortest"));
      statsAdvancedToggle.addEventListener("click", () => {
        const hidden = statsAdvancedPanel.hasAttribute("hidden");
        if (hidden) {
          statsAdvancedPanel.removeAttribute("hidden");
          statsAdvancedToggle.textContent = "收起高级选项";
        } else {
          statsAdvancedPanel.setAttribute("hidden", "hidden");
          statsAdvancedToggle.textContent = "高级选项";
        }
      });
      statsModalClose.addEventListener("click", () => {
        statsFunctionModal.classList.remove("active");
      });
      statsFunctionModal.addEventListener("click", (event) => {
        if (event.target === statsFunctionModal) {
          statsFunctionModal.classList.remove("active");
        }
      });

      if (attendanceStartButton) {
        attendanceStartButton.addEventListener("click", () => startAttendanceSession());
      }
      if (attendanceEndButton) {
        attendanceEndButton.addEventListener("click", () => endAttendanceSession());
      }
      if (attendancePrevButton) {
        attendancePrevButton.addEventListener("click", () => fetchPreviousAttendanceStudent());
      }
      if (attendanceNextButton) {
        attendanceNextButton.addEventListener("click", () => fetchNextAttendanceStudent());
      }
      attendanceActionButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const status = button.dataset.status;
          if (status) {
            submitAttendance(status);
          }
        });
      });

      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          let handled = false;
          if (!duckDialog.hidden) {
            closeDuckDialog();
            handled = true;
          }
          if (!statsDialog.hidden) {
            closeStatsDialog();
            handled = true;
          }
          if (handled) {
            event.preventDefault();
            return;
          }
        }

        if (!gameStarted || gamePaused) {
          return;
        }
        switch (event.key) {
          case "w":
          case "ArrowUp":
            sendMove("up");
            break;
          case "s":
          case "ArrowDown":
            sendMove("down");
            break;
          case "a":
          case "ArrowLeft":
            sendMove("left");
            break;
          case "d":
          case "ArrowRight":
            sendMove("right");
            break;
          default:
            break;
        }
      });

      async function startGame() {
        if (gameStarted) {
          return;
        }
        startButton.disabled = true;
        setHudPlaceholders();
        statusEl.textContent = "正在准备飞行...";
        try {
          const response = await fetch("/reset", { method: "POST" });
          if (!response.ok) {
            throw new Error("reset failed");
          }
          gameStarted = true;
          gameFinished = false;
          gamePaused = false;
          rainInProgress = false;
          startOverlay.hidden = true;
          pauseButton.disabled = false;
          if (topPauseButton) topPauseButton.disabled = false;
          if (floatingPauseButton) floatingPauseButton.disabled = false;
          pauseButton.textContent = "暂停";
          if (topPauseButton) topPauseButton.textContent = "暂停";
          if (floatingPauseButton) floatingPauseButton.textContent = "暂停";
          resetButton.disabled = false;
          if (topResetButton) topResetButton.disabled = false;
          rainButton.disabled = false;
          await refreshState(true);
          startPolling();
          statusEl.textContent = "任务进行中";
        } catch (error) {
          statusEl.textContent = "启动失败，请稍后重试";
          startButton.disabled = false;
          gameStarted = false;
          console.error(error);
        }
      }

      async function resetGame() {
        if (!gameStarted) {
          return;
        }
        stopPolling();
        resetButton.disabled = true;
        pauseButton.disabled = true;
        if (topResetButton) topResetButton.disabled = true;
        if (topPauseButton) topPauseButton.disabled = true;
        if (floatingPauseButton) floatingPauseButton.disabled = true;
        statusEl.textContent = "重新部署中...";
        setHudPlaceholders();
        try {
          const response = await fetch("/reset", { method: "POST" });
          if (!response.ok) {
            throw new Error("reset failed");
          }
          gameFinished = false;
          gamePaused = false;
          rainInProgress = false;
          rainOverlay.classList.remove("active");
          rainOverlay.innerHTML = "";
          pauseButton.textContent = "暂停";
          if (topPauseButton) topPauseButton.textContent = "暂停";
          if (floatingPauseButton) floatingPauseButton.textContent = "暂停";
          await refreshState(true);
          startPolling();
          statusEl.textContent = "任务进行中";
        } catch (error) {
          statusEl.textContent = "重置失败，请重试";
          console.error(error);
        } finally {
          resetButton.disabled = false;
          if (topResetButton) topResetButton.disabled = false;
          pauseButton.disabled = !gameStarted;
          if (topPauseButton) topPauseButton.disabled = !gameStarted;
          if (floatingPauseButton) floatingPauseButton.disabled = !gameStarted;
          rainButton.disabled = gameFinished || gamePaused;
        }
      }

      async function togglePause() {
        if (!gameStarted || gameFinished) {
          return;
        }
        pauseButton.disabled = true;
        if (topPauseButton) topPauseButton.disabled = true;
        if (floatingPauseButton) floatingPauseButton.disabled = true;
        statusEl.textContent = gamePaused ? "恢复飞行中..." : "悬停中...";
        try {
          const response = await fetch("/pause", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "action=toggle",
          });
          if (!response.ok) {
            throw new Error("pause failed");
          }
          const data = await response.json();
          gamePaused = Boolean(data.paused);
          const label = gamePaused ? "继续" : "暂停";
          pauseButton.textContent = label;
          if (topPauseButton) topPauseButton.textContent = label;
          if (floatingPauseButton) floatingPauseButton.textContent = label;
          if (gamePaused) {
            stopPolling();
          } else {
            startPolling();
          }
          await refreshState(true);
          statusEl.textContent = gamePaused ? "任务已暂停" : "任务进行中";
        } catch (error) {
          statusEl.textContent = "暂停操作失败，请重试";
          console.error(error);
        } finally {
          pauseButton.disabled = false;
          if (topPauseButton) topPauseButton.disabled = false;
          if (floatingPauseButton) floatingPauseButton.disabled = false;
          rainButton.disabled = gameFinished || gamePaused || rainInProgress;
        }
      }

      function openDuckDialog() {
        duckUiManager.closeSettings();
        duckDialog.hidden = false;
        duckInput.value = "";
        duckResponse.textContent = duckDefaultGreeting;
        setTimeout(() => duckInput.focus(), 0);
      }

      function closeDuckDialog() {
        duckDialog.hidden = true;
      }

      function openDuckSettings() {
        duckUiManager.openSettings();
      }

      function closeDuckSettings() {
        duckUiManager.closeSettings();
      }

      function openStatsDialog() {
        statsDialog.hidden = false;
        statsDirectory.value = statsDirectory.value || ".";
        statsMessage.textContent = "";
        statsResults.hidden = true;
        statsAdvancedPanel.setAttribute("hidden", "hidden");
        statsAdvancedToggle.textContent = "高级选项";
        setTimeout(() => statsDirectory.focus(), 0);
      }

      function closeStatsDialog() {
        statsDialog.hidden = true;
      }

      function getSelectedFormat() {
        const active = statsFormatRadios.find((radio) => radio.checked);
        return active ? active.value : "none";
      }

      async function runStats() {
        const input = statsDirectory.value.trim();
        const directory = input.length === 0 ? "." : input;
        const selectedLanguages = Object.entries(statsLanguageChecks)
          .filter(([, checkbox]) => checkbox.checked)
          .map(([key]) => key);
        const includeBlank = statsIncludeBlank.checked;
        const includeComments = statsIncludeComments.checked;
        const selectedFormat = getSelectedFormat();

        if (selectedLanguages.length === 0) {
          statsMessage.textContent = "请选择至少一种语言后再开始扫描。";
          return;
        }

        statsMessage.textContent = "正在扫描代码...";
        statsResults.hidden = true;
        try {
          const bodyParams = new URLSearchParams();
          bodyParams.set("directory", directory);
          bodyParams.set("languages", selectedLanguages.join(","));
          bodyParams.set("includeBlank", includeBlank ? "true" : "false");
          bodyParams.set("includeComments", includeComments ? "true" : "false");

          const response = await fetch("/codestats", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: bodyParams.toString(),
          });
          if (!response.ok) {
            let errorMessage = "统计失败，请检查目录是否可访问。";
            try {
              const errorData = await response.json();
              if (errorData && errorData.error) {
                errorMessage = errorData.error;
              }
            } catch {
              const fallback = await response.text();
              if (fallback) {
                errorMessage = fallback;
              }
            }
            throw new Error(errorMessage);
          }

          const data = await response.json();
          updateStatsView(data);
          const total = data.totalLines ?? 0;
          statsMessage.textContent =
            `目录 ${data.directory ?? directory} 的统计完成，总计 ${total} 行代码。`;
          statsResults.dataset.directory = data.directory ?? directory;
          statsResults.dataset.languages = selectedLanguages.join(",");
          statsResults.dataset.includeBlank = includeBlank ? "true" : "false";
          statsResults.dataset.includeComments = includeComments ? "true" : "false";
          statsResults.dataset.format = selectedFormat;
          if (selectedFormat !== "none") {
            await downloadStatsReport(selectedFormat, directory, selectedLanguages, includeBlank, includeComments);
          }
        } catch (error) {
          statsMessage.textContent = error && error.message ? error.message : "统计失败，请重试。";
          console.error(error);
        }
      }

      function updateStatsView(data) {
        statsResults.hidden = false;
        const languages = data.languages || [];
        const colors = ["#38bdf8", "#22d3ee", "#a855f7", "#f472b6", "#fb923c", "#facc15"];
        const includeBlank = Boolean(data.includeBlank);
        const includeComments = Boolean(data.includeComments);

        statsResults.dataset.includeBlank = includeBlank ? "true" : "false";
        statsResults.dataset.includeComments = includeComments ? "true" : "false";

        let languageTokens = [];
        if (Array.isArray(languages) && languages.length > 0) {
          languageTokens = languages
            .map((item) => String(item.language || "").trim())
            .filter((name) => name.length > 0);
        }
        if (languageTokens.length === 0 && Array.isArray(data.includedLanguages)) {
          languageTokens = data.includedLanguages
            .map((item) => String(item).trim())
            .filter((name) => name.length > 0);
        }
        statsResults.dataset.languages = languageTokens.join(",");
        const fallbackDirectory = statsDirectory.value.trim() || ".";
        statsResults.dataset.directory = data.directory ?? fallbackDirectory;

        statsBarChart.innerHTML = "";
        const maxLines = Math.max(1, ...languages.map((item) => item.lines));

        languages.forEach((item, index) => {
          const row = document.createElement("div");
          row.className = "bar-row";

          const label = document.createElement("div");
          label.className = "bar-label";
          label.textContent = item.language;

          const track = document.createElement("div");
          track.className = "bar-track";

          const fill = document.createElement("div");
          fill.className = "bar-fill";
          fill.style.width = `${maxLines === 0 ? 0 : (item.lines / maxLines) * 100}%`;
          fill.style.background = `linear-gradient(90deg, ${colors[index % colors.length]}, ${colors[(index + 1) % colors.length]})`;

          const value = document.createElement("span");
          let detailText = `${item.lines} 行`;
          if (includeBlank) {
            const blanks = item.blankLines ?? 0;
            detailText += `，空行 ${blanks}`;
          }
          if (includeComments) {
            const comments = item.commentLines ?? 0;
            detailText += `，注释 ${comments}`;
          }
          value.textContent = detailText;
          value.style.color = "var(--text-secondary)";

          track.appendChild(fill);
          row.append(label, track, value);
          statsBarChart.appendChild(row);
        });

        const totalLines = data.totalLines || 0;
        let start = 0;
        const pieSegments = languages
          .map((item, index) => {
            const percent = totalLines === 0 ? 0 : (item.lines / totalLines) * 100;
            const segment = `${colors[index % colors.length]} ${start}% ${start + percent}%`;
            start += percent;
            return segment;
          })
          .join(", ");
        statsPieChart.style.background = pieSegments
          ? `conic-gradient(${pieSegments})`
          : "rgba(148, 163, 184, 0.12)";

        statsPieLegend.innerHTML = "";
        languages.forEach((item, index) => {
          const legendItem = document.createElement("div");
          legendItem.className = "pie-legend-item";

          const colorBox = document.createElement("div");
          colorBox.className = "pie-color";
          colorBox.style.background = colors[index % colors.length];

          const percent = totalLines === 0 ? 0 : ((item.lines / totalLines) * 100).toFixed(1);
          const text = document.createElement("span");
          text.textContent = `${item.language}: ${item.lines} 行 (${percent}%)`;

          legendItem.append(colorBox, text);
          statsPieLegend.appendChild(legendItem);
        });

        const formatFloat = (value) => (Number.isFinite(value) ? value.toFixed(2) : "0.00");
        statsFunctionSummary.innerHTML = "";
        if (languages.length === 0) {
          statsFunctionSummary.textContent = "暂无函数统计数据。";
        } else {
          const table = document.createElement("table");
          table.className = "stats-function-table";
          table.innerHTML =
            "<thead><tr><th>语言</th><th>函数数</th><th>最短</th><th>最长</th><th>平均</th><th>中位</th></tr></thead>";
          const tbody = document.createElement("tbody");
          languages.forEach((item) => {
            const fn = item.functions || {};
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${item.language}</td>
              <td>${fn.count || 0}</td>
              <td>${fn.min || 0}</td>
              <td>${fn.max || 0}</td>
              <td>${formatFloat(fn.average)}</td>
              <td>${formatFloat(fn.median)}</td>
            `;
            tbody.appendChild(row);
          });
          table.appendChild(tbody);
          statsFunctionSummary.appendChild(table);
        }

        if (data.directory) {
          statsResults.dataset.directory = data.directory;
        }
      }

      async function downloadStatsReport(format, directory, languages, includeBlank, includeComments) {
        try {
          const bodyParams = new URLSearchParams();
          bodyParams.set("directory", directory);
          if (languages.length > 0) {
            bodyParams.set("languages", languages.join(","));
          }
          bodyParams.set("includeBlank", includeBlank ? "true" : "false");
          bodyParams.set("includeComments", includeComments ? "true" : "false");
          bodyParams.set("format", format);

          const response = await fetch("/codestats/export", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: bodyParams.toString(),
          });
          if (!response.ok) {
            const errorText = await response.text();
            statsMessage.textContent = errorText || "导出失败，请检查服务器日志。";
            return;
          }
          const blob = await response.blob();
          const disposition = response.headers.get("Content-Disposition") || "";
          let filename = "code-report." + format;
          const match = disposition.match(/filename=\"?([^\";]+)\"?/);
          if (match && match[1]) {
            filename = match[1];
          }
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        } catch (error) {
          statsMessage.textContent = "导出失败，请稍后重试。";
          console.error(error);
        }
      }

      async function printFunctionSummary(type) {
        if (statsResults.hidden) {
          statsMessage.textContent = "请先完成一次扫描后再打印函数信息。";
          return;
        }
        const directory =
          statsResults.dataset.directory && statsResults.dataset.directory.length > 0
            ? statsResults.dataset.directory
            : statsDirectory.value.trim() || ".";
        let languagesParam = [];
        if (statsResults.dataset.languages && statsResults.dataset.languages.length > 0) {
          languagesParam = statsResults.dataset.languages
            .split(",")
            .map((item) => item.trim())
            .filter((item) => item.length > 0);
        } else {
          languagesParam = Object.entries(statsLanguageChecks)
            .filter(([, checkbox]) => checkbox.checked)
            .map(([key]) => key);
        }
        const includeBlank =
          statsResults.dataset.includeBlank === "true" || statsIncludeBlank.checked;
        const includeComments =
          statsResults.dataset.includeComments === "true" || statsIncludeComments.checked;
        const endpoint =
          type === "longest" ? "/print_longest_function" : "/print_shortest_function";

        try {
          const bodyParams = new URLSearchParams();
          bodyParams.set("directory", directory);
          if (languagesParam.length > 0) {
            bodyParams.set("languages", languagesParam.join(","));
          }
          bodyParams.set("includeBlank", includeBlank ? "true" : "false");
          bodyParams.set("includeComments", includeComments ? "true" : "false");

          const response = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: bodyParams.toString(),
          });
          if (!response.ok) {
            throw new Error("打印失败，请检查服务器返回。");
          }
          const data = await response.json();
          if (data && data.success) {
            statsModalTitle.textContent = type === "longest" ? "最长函数" : "最短函数";
            statsModalMessage.textContent = data.message || "函数信息已打印。";
            statsFunctionModal.classList.add("active");
          } else {
            statsMessage.textContent =
              (data && data.message) || "打印失败，请稍后再试。";
          }
        } catch (error) {
          statsMessage.textContent =
            error && error.message ? error.message : "打印失败，请稍后再试。";
          console.error(error);
        }
      }

      const duckAiDefaults = {
        // 阿里云百炼（DashScope）OpenAI 兼容模式：Chat Completions
        endpoint: "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions",
        // 可通过 window.DUCK_OPENAI_MODEL 覆盖（如 qwen-plus / qwen3-* 等）
        model: "qwen-plus",
        systemPrompt: "你是飞行助手小鸭，请用亲切的语气回复玩家，保持回答精炼。",
        temperature: 0.7,
      };

      async function invokeDuckAI(message) {
        if (typeof window.duckAiHandler === "function") {
          try {
            const custom = await window.duckAiHandler(message);
            if (custom && custom.length > 0) {
              return custom;
            }
          } catch (error) {
            console.error("Duck AI custom handler error", error);
          }
        }

        const config = window.DUCK_OPENAI_CONFIG || {};
        const apiKey = window.DUCK_OPENAI_KEY || config.apiKey;
        const endpoint = config.endpoint || window.DUCK_OPENAI_ENDPOINT || duckAiDefaults.endpoint;
        const model = config.model || window.DUCK_OPENAI_MODEL || duckAiDefaults.model;
        const temperature =
          typeof config.temperature === "number"
            ? config.temperature
            : typeof window.DUCK_OPENAI_TEMPERATURE === "number"
              ? window.DUCK_OPENAI_TEMPERATURE
              : duckAiDefaults.temperature;
        const systemPrompt = config.systemPrompt || window.DUCK_OPENAI_SYSTEM_PROMPT || duckAiDefaults.systemPrompt;

        const payload = {
          model,
          temperature,
          messages: [
            { role: "system", content: systemPrompt },
            { role: "user", content: message },
          ],
        };

        try {
          const response = apiKey
            ? await fetch(endpoint, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${apiKey}`,
                },
                body: JSON.stringify(payload),
              })
            : await fetch("/duckai", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ model, systemPrompt, message }),
              });
          if (!response.ok) {
            console.error("Duck AI response error", await response.text());
            return "";
          }
          const data = await response.json();
          const text = data?.choices?.[0]?.message?.content;
          return text ? text.trim() : "";
        } catch (error) {
          console.error("调用 Duck AI 接口失败", error);
          return "";
        }
      }

      async function submitDuckCommand() {
        const command = duckInput.value.trim();
        if (!command) {
          duckResponse.textContent = "请输入命令";
          duckInput.focus();
          return;
        }
        if (command.includes("红包雨")) {
          duckResponse.textContent = "空袭准备中...";
          try {
            await triggerRain();
            duckResponse.textContent = "空袭完成，注意查看战绩！";
          } catch (error) {
            duckResponse.textContent = "空袭失败，请稍后再试";
            console.error(error);
          }
        } else {
          duckResponse.textContent = "正在为你连接机载 AI...";
          const aiReply = await invokeDuckAI(command);
          if (aiReply && aiReply.length > 0) {
            duckResponse.textContent = aiReply;
          } else {
            // Avoid flashing the fallback while the AI response is still in-flight.
            duckResponse.textContent = "AI 正在思考，请稍等...";
            await delay(1500);
            duckResponse.textContent = "AI 接口尚未接入，持续升级中！";
          }
        }
      }

      async function triggerRain() {
        if (!gameStarted || gameFinished || rainInProgress || gamePaused) {
          return;
        }
        rainInProgress = true;
        rainButton.disabled = true;
        statusEl.textContent = "空袭蓄力中...";
        startRainAnimation();
        try {
          await delay(RAIN_ANIMATION_DURATION);
          const response = await fetch("/rain", { method: "POST" });
          if (!response.ok) {
            throw new Error("rain failed");
          }
          const data = await response.json();
          await refreshState();
          statusEl.textContent = `红包雨完成！新增 ${data.spawned ?? 0} 个红包。`;
        } catch (error) {
          statusEl.textContent = "红包雨触发失败，请重试";
          console.error(error);
        } finally {
          rainInProgress = false;
          rainButton.disabled = gameFinished || gamePaused;
        }
      }

      function startRainAnimation() {
        rainOverlay.innerHTML = "";
        rainOverlay.classList.add("active");
        for (let i = 0; i < RAIN_DROP_COUNT; i += 1) {
          const drop = document.createElement("div");
          drop.classList.add("rain-drop");
          const sizeIndex = Math.floor(Math.random() * 3);
          const sizeClass = sizeIndex === 0 ? "shape-small" : sizeIndex === 1 ? "shape-medium" : "shape-large";
          drop.classList.add(sizeClass);
          const label = document.createElement("span");
          label.classList.add("shape-size");
          label.textContent = sizeIndex === 0 ? "小" : sizeIndex === 1 ? "中" : "大";
          drop.appendChild(label);
          drop.style.left = `${Math.random() * 100}%`;
          const delayValue = Math.random() * 0.5;
          const duration = 2 + Math.random() * 0.8;
          drop.style.animationDelay = `${delayValue}s`;
          drop.style.animationDuration = `${duration}s`;
          rainOverlay.appendChild(drop);
        }
        setTimeout(() => {
          rainOverlay.classList.remove("active");
          rainOverlay.innerHTML = "";
        }, RAIN_ANIMATION_DURATION);
      }

      async function sendMove(direction) {
        if (!gameStarted || gamePaused) {
          return;
        }
        try {
          await fetch("/move", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: `direction=${direction}`,
          });
          await refreshState();
        } catch (error) {
          console.error(error);
        }
      }

      async function refreshState(force = false) {
        if (!gameStarted && !force) {
          return;
        }
        try {
          const response = await fetch("/state");
          if (!response.ok) {
            throw new Error("state fetch failed");
          }
          const data = await response.json();
          renderState(data);
        } catch (error) {
          statusEl.textContent = "无法连接服务器";
          summaryEl.hidden = true;
          setControlsEnabled(false);
          resetButton.disabled = true;
          pauseButton.disabled = true;
          rainButton.disabled = true;
          console.error(error);
        }
      }

      function renderState(state) {
        ensureBattlefieldDimensions(state.worldWidth, state.worldHeight);
        timeLeftEl.textContent = state.timeLeft.toFixed(1);
        countEl.textContent = state.stats.count ?? 0;
        valueEl.textContent = state.stats.value ?? 0;

        gamePaused = Boolean(state.paused);
        const finished = state.timeLeft <= 0;
        gameFinished = finished;

        if (finished) {
          statusEl.textContent = "任务结束";
        } else if (gamePaused) {
          statusEl.textContent = "任务已暂停";
        } else {
          statusEl.textContent = "任务进行中";
        }

        if (finished) {
          summaryEl.hidden = false;
          summaryBodyEl.innerHTML =
            `本次任务共拾取 <strong>${state.stats.count}</strong> 个红包，` +
            `累计金额 <strong>${state.stats.value}</strong> 元。<br />` +
            `作战区域：${state.worldWidth} × ${state.worldHeight}，倒计时 ${state.timeLimit} 秒。`;
        } else {
          summaryEl.hidden = true;
        }

        setControlsEnabled(!finished && !gamePaused);
        rainButton.disabled = finished || gamePaused || rainInProgress;
        pauseButton.disabled = !gameStarted || finished;
        pauseButton.textContent = gamePaused ? "继续" : "暂停";
        resetButton.disabled = !gameStarted;

        applyEnvelopeUpdates(state.envelopes ?? []);
        updateTankPosition(state.tank);
      }
    </script>
  </body>
</html>
