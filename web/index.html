<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>坦克抢红包</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      }

      body {
        margin: 0;
        padding: 0;
        background: #0e1116;
        color: #f8f8f2;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
      }

      header {
        width: 100%;
        padding: 1rem;
        background: linear-gradient(135deg, #303952, #596275);
        text-align: center;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
      }

      main {
        width: min(960px, 100%);
        padding: 1rem 1.5rem 2rem;
        box-sizing: border-box;
      }

      .hud {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
      }

      .hud-card {
        background: rgba(255, 255, 255, 0.06);
        padding: 0.75rem 1.25rem;
        border-radius: 0.75rem;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
        min-width: 180px;
      }

      .grid-container {
        display: flex;
        justify-content: center;
      }

      #grid {
        display: grid;
        gap: 2px;
        background: #1f242d;
        padding: 8px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.45);
      }

      .cell {
        width: 20px;
        height: 20px;
        background: #3a3f4b;
        border-radius: 3px;
        transition: transform 0.1s ease-out;
      }

      .cell.envelope-small {
        background: #ffd36b;
      }

      .cell.envelope-medium {
        background: #ff9f1c;
      }

      .cell.envelope-large {
        background: #ff4d6d;
      }

      .cell.tank {
        background: #4acf81;
        transform: scale(1.1);
        box-shadow: 0 0 6px rgba(74, 207, 129, 0.8);
      }

      .controls {
        margin-top: 1.5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
      }

      .control-grid {
        display: grid;
        grid-template-columns: repeat(3, 64px);
        grid-template-rows: repeat(3, 64px);
        gap: 0.5rem;
      }

      button {
        background: #596275;
        color: #f8f8f2;
        border: none;
        border-radius: 0.75rem;
        font-size: 1rem;
        cursor: pointer;
        transition: transform 0.15s ease, background 0.3s ease;
      }

      button:hover,
      button:focus {
        transform: translateY(-2px);
        background: #778beb;
        outline: none;
      }

      .wide-button {
        padding: 0.7rem 1.4rem;
        width: 260px;
      }

      footer {
        margin-top: auto;
        padding: 1rem;
        color: rgba(255, 255, 255, 0.65);
        font-size: 0.85rem;
      }

      .status {
        color: #f8f8f2;
        font-weight: 600;
      }

      @media (max-width: 768px) {
        .cell {
          width: 16px;
          height: 16px;
        }

        .control-grid {
          grid-template-columns: repeat(3, 54px);
          grid-template-rows: repeat(3, 54px);
        }

        button {
          font-size: 0.95rem;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>坦克红包挑战</h1>
      <p>使用方向键或点击按钮移动坦克，抢在时间结束前拾取更多红包！</p>
    </header>
    <main>
      <section class="hud">
        <div class="hud-card">
          <div>剩余时间</div>
          <div class="status"><span id="time-left">--</span> 秒</div>
        </div>
        <div class="hud-card">
          <div>红包数量</div>
          <div class="status"><span id="count">--</span> 个</div>
        </div>
        <div class="hud-card">
          <div>红包金额</div>
          <div class="status"><span id="value">--</span> 元</div>
        </div>
        <div class="hud-card">
          <div>当前状态</div>
          <div class="status" id="game-status">加载中...</div>
        </div>
      </section>

      <section class="grid-container">
        <div id="grid"></div>
      </section>

      <section class="controls">
        <div class="control-grid">
          <div></div>
          <button id="btn-up">▲</button>
          <div></div>
          <button id="btn-left">◀</button>
          <div></div>
          <button id="btn-right">▶</button>
          <div></div>
          <button id="btn-down">▼</button>
          <div></div>
        </div>
        <button id="btn-reset" class="wide-button">重新开始</button>
        <div>提示：也可以使用键盘 W/A/S/D 或箭头键来移动坦克。</div>
      </section>
    </main>
    <footer>端口由服务器控制（默认 8080），可通过命令行或环境变量 TANK_GAME_PORT 调整。</footer>

    <script>
      const timeLeftEl = document.getElementById("time-left");
      const countEl = document.getElementById("count");
      const valueEl = document.getElementById("value");
      const gridEl = document.getElementById("grid");
      const statusEl = document.getElementById("game-status");

      const directionButtons = {
        up: document.getElementById("btn-up"),
        down: document.getElementById("btn-down"),
        left: document.getElementById("btn-left"),
        right: document.getElementById("btn-right"),
      };

      document.getElementById("btn-reset").addEventListener("click", async () => {
        await fetch("/reset", { method: "POST" });
        await refreshState();
      });

      for (const [direction, button] of Object.entries(directionButtons)) {
        button.addEventListener("click", () => sendMove(direction));
      }

      async function sendMove(direction) {
        await fetch("/move", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `direction=${direction}`,
        });
        await refreshState();
      }

      document.addEventListener("keydown", (event) => {
        switch (event.key) {
          case "w":
          case "ArrowUp":
            sendMove("up");
            break;
          case "s":
          case "ArrowDown":
            sendMove("down");
            break;
          case "a":
          case "ArrowLeft":
            sendMove("left");
            break;
          case "d":
          case "ArrowRight":
            sendMove("right");
            break;
          default:
            break;
        }
      });

      async function refreshState() {
        try {
          const response = await fetch("/state");
          const data = await response.json();
          renderState(data);
        } catch (error) {
          statusEl.textContent = "无法连接服务器";
        }
      }

      function renderState(state) {
        timeLeftEl.textContent = state.timeLeft.toFixed(1);
        countEl.textContent = state.stats.count;
        valueEl.textContent = state.stats.value;
        statusEl.textContent = state.timeLeft <= 0 ? "时间结束" : "游戏进行中";

        gridEl.style.gridTemplateColumns = `repeat(${state.worldWidth}, 20px)`;
        gridEl.innerHTML = "";

        const cells = [];
        for (let y = 0; y < state.worldHeight; y += 1) {
          for (let x = 0; x < state.worldWidth; x += 1) {
            const cell = document.createElement("div");
            cell.classList.add("cell");
            cells.push(cell);
            gridEl.appendChild(cell);
          }
        }

        state.envelopes.forEach((envelope) => {
          const index = envelope.y * state.worldWidth + envelope.x;
          if (index >= 0 && index < cells.length) {
            const cell = cells[index];
            if (envelope.size === "Small") {
              cell.classList.add("envelope-small");
            } else if (envelope.size === "Medium") {
              cell.classList.add("envelope-medium");
            } else {
              cell.classList.add("envelope-large");
            }
          }
        });

        const tankIndex = state.tank.y * state.worldWidth + state.tank.x;
        if (tankIndex >= 0 && tankIndex < cells.length) {
          cells[tankIndex].classList.add("tank");
        }
      }

      setInterval(refreshState, 500);
      refreshState();
    </script>
  </body>
</html>
